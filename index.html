<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>è¨€è‘‰ | Kotoba Vocabulary Trainer</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="/static/logo.svg?v=1">
    <link rel="apple-touch-icon" href="/static/icon-192.png">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="è¨€è‘‰">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#667eea">
    
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="/static/keyboard.css">
    <script>
        (function () {
            function prepareModuleEnv() {
                window.module = { exports: {} };
                window.exports = window.module.exports;
            }

            window.__captureModule = function (target) {
                if (!window.module || !window.module.exports) {
                    return;
                }
                const exported = window.module.exports;
                const ctor = exported && (exported.default || exported[target] || exported);
                if (ctor) {
                    window[target] = ctor;
                }
                prepareModuleEnv();
            };

            if (typeof window.require === 'undefined') {
                window.require = function (name) {
                    if (name === 'kuromoji') {
                        return window.kuromoji;
                    }
                    return null;
                };
            }

            prepareModuleEnv();
        })();
    </script>
    <script defer src="/static/vendor/kuromoji/kuromoji.js"></script>
    <script defer src="/static/vendor/kuroshiro/kuroshiro.min.js" onload="window.__captureModule('Kuroshiro')"></script>
    <script defer src="/static/vendor/kuroshiro-analyzer-kuromoji/kuroshiro-analyzer-kuromoji.min.js" onload="window.__captureModule('KuromojiAnalyzer')"></script>
    <script defer src="/static/vendor/wanakana/wanakana.min.js" onload="window.__captureModule('wanakana')"></script>
    <script>
        window.addEventListener('load', function () {
            delete window.module;
            delete window.exports;
            delete window.require;
            delete window.__captureModule;
        });
    </script>
    <script defer src="/static/app.js"></script>
</head>
<body>
    <div class="app">
        <header class="app-header">
            <div class="header-left">
                <div class="branding">
                    <span class="branding-logo" aria-hidden="true">
                        <img src="/static/logo.svg" alt="Kotoba" width="42" height="42">
                    </span>
                    <a href="/" class="branding-title">è¨€è‘‰</a>
                </div>
            </div>
            <!-- header-resources removed per request -->
            <div class="header-actions">
                <button id="autoPronounceBtn" class="ghost-button" title="è‡ªå‹•ç™ºéŸ³ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§åˆ‡æ›¿ï¼‰" aria-pressed="false" aria-label="è‡ªå‹•ç™ºéŸ³">
                    è‡ªå‹•ç™ºéŸ³
                </button>
                <button id="keyboard-toggle" class="ghost-button" type="button" title="Virtual Keyboard">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                        <rect x="4" y="6" width="2" height="2" rx="0.5"></rect>
                        <rect x="7" y="6" width="2" height="2" rx="0.5"></rect>
                        <rect x="10" y="6" width="2" height="2" rx="0.5"></rect>
                        <rect x="13" y="6" width="2" height="2" rx="0.5"></rect>
                        <rect x="16" y="6" width="2" height="2" rx="0.5"></rect>
                        <rect x="4" y="9" width="2" height="2" rx="0.5"></rect>
                        <rect x="7" y="9" width="2" height="2" rx="0.5"></rect>
                        <rect x="10" y="9" width="2" height="2" rx="0.5"></rect>
                        <rect x="13" y="9" width="2" height="2" rx="0.5"></rect>
                        <rect x="16" y="9" width="2" height="2" rx="0.5"></rect>
                        <rect x="4" y="12" width="2" height="2" rx="0.5"></rect>
                        <rect x="7" y="12" width="2" height="2" rx="0.5"></rect>
                        <rect x="10" y="12" width="2" height="2" rx="0.5"></rect>
                        <rect x="13" y="12" width="2" height="2" rx="0.5"></rect>
                        <rect x="16" y="12" width="2" height="2" rx="0.5"></rect>
                    </svg>
                </button>
                <!-- æ¨¡å¼åˆ‡æ¢å™¨ -->
                <div class="mode-switcher">
                    <button id="mode-input" class="mode-btn active" title="å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button id="mode-puzzle" class="mode-btn" title="ãƒ‘ã‚ºãƒ«ãƒ¢ãƒ¼ãƒ‰">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19.439 7.85c-.049.322.059.648.289.878l1.568 1.568c.47.47.706 1.087.706 1.704s-.235 1.233-.706 1.704l-1.611 1.611a.98.98 0 0 1-.837.276c-.47-.07-.802-.48-.968-.925a2.501 2.501 0 1 0-3.214 3.214c.446.166.855.497.925.968a.979.979 0 0 1-.276.837l-1.61 1.61a2.404 2.404 0 0 1-1.705.707 2.402 2.402 0 0 1-1.704-.706l-1.568-1.568a1.026 1.026 0 0 0-.877-.29c-.493.074-.84.504-1.02.968a2.5 2.5 0 1 1-3.237-3.237c.464-.18.894-.527.967-1.02a1.026 1.026 0 0 0-.289-.877l-1.568-1.568A2.402 2.402 0 0 1 1.998 12c0-.617.236-1.234.706-1.704L4.23 8.77c.24-.24.581-.353.917-.303.515.077.877.528 1.073 1.01a2.5 2.5 0 1 0 3.259-3.259c-.482-.196-.933-.558-1.01-1.073-.05-.336.062-.676.303-.917l1.525-1.525A2.402 2.402 0 0 1 12 1.998c.617 0 1.234.236 1.704.706l1.568 1.568c.23.23.556.338.877.29.493-.074.84-.504 1.02-.968a2.5 2.5 0 1 1 3.237 3.237c-.464.18-.894.527-.967 1.02z"></path>
                        </svg>
                    </button>
                    <button id="mode-play" class="mode-btn" title="å†ç”Ÿãƒ¢ãƒ¼ãƒ‰" style="display: none;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                    </button>
                </div>
                <!-- æ’è¡Œæ¦œå…¥å£æŒ‰é’®ï¼ˆæ”¾åœ¨ user-account å³ä¾§ï¼‰ -->
                <button id="headerLeaderboardBtn" class="header-leaderboard-btn" title="ãƒ©ãƒ³ã‚­ãƒ³ã‚°" style="display:none;">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 21h8"/>
                        <path d="M12 17v4"/>
                        <path d="M7 4h10v5l-5 3-5-3V4z"/>
                        <path d="M5 9H4a2 2 0 0 1-2-2V5h3"/>
                        <path d="M19 9h1a2 2 0 0 0 2-2V5h-3"/>
                    </svg>
                </button>

                <!-- ç”¨æˆ·è´¦æˆ· -->
                <div class="user-account">
                    <!-- æœªç™»å½•èœå•è§¦å‘å™¨ -->
                    <div id="guestProfile" class="user-profile" style="display: flex;">
                        <button class="guest-menu-trigger" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                        </button>
                        <div id="guestMenu" class="user-menu">
                            <button id="loginButtonMenu" class="user-menu-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                                </svg>
                                <span>ãƒ­ã‚°ã‚¤ãƒ³</span>
                            </button>
                            <div class="user-menu-divider"></div>
                            <button id="dictionaryButtonMenuGuest" class="user-menu-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                    <line x1="10" y1="8" x2="16" y2="8"></line>
                                    <line x1="10" y1="12" x2="16" y2="12"></line>
                                    <line x1="10" y1="16" x2="14" y2="16"></line>
                                </svg>
                                <span>è¾æ›¸ã‚’åˆ‡ã‚Šæ›¿ãˆ</span>
                            </button>
                            <button id="settingsButtonMenuGuest" class="user-menu-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"></path>
                                </svg>
                                <span>è¨­å®š</span>
                            </button>
                            <button id="clearEnvButtonGuest" class="user-menu-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18"></path>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                                    <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                                <span>ç’°å¢ƒã‚’ã‚¯ãƒªã‚¢</span>
                            </button>
                            <button id="downloadOfflineGuest" class="user-menu-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                <span>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</span>
                            </button>
                            <div class="user-menu-divider"></div>
                            <a id="helpLinkUser" class="user-menu-item" href="/help.html" target="_blank">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9 9a3 3 0 1 1 5.2 2.2c-.7.7-1.2 1.1-1.2 2.3"></path>
                                    <line x1="12" y1="17" x2="12" y2="17"></line>
                                </svg>
                                <span>ãƒ˜ãƒ«ãƒ—</span>
                            </a>
                            <button id="installPWAGuest" class="user-menu-item" style="display: none;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                <span>ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</span>
                            </button>
                        </div>
                    </div>
                    <!-- å·²ç™»å½•ç”¨æˆ·èµ„æ–™ -->
                    <div id="userProfile" class="user-profile" style="display: none;">
                        <img id="userAvatar" class="user-avatar" src="" alt="User">
                        <div id="userMenu" class="user-menu">
                            <div class="user-menu-header">
                                <img id="userAvatarMenu" class="user-avatar-large" src="" alt="User">
                                <div class="user-info">
                                    <div id="userNameMenu" class="user-name"></div>
                                    <div id="userEmailMenu" class="user-email"></div>
                                </div>
                            </div>
                            <div class="user-menu-divider"></div>
                            <button id="syncDataButton" class="user-menu-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 4 23 10 17 10"></polyline>
                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                                </svg>
                                <span>ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸ</span>
                            </button>
                            <button id="viewWrongWordsButton" class="user-menu-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                                <span>çµ±è¨ˆ</span>
                            </button>
                            <button id="practiceWrongWordsButton" class="user-menu-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                                </svg>
                                <span>éŒ¯é¡Œã‚’ç·´ç¿’</span>
                            </button>
                            
                            <div class="user-menu-divider"></div>
                            <button id="dictionaryButtonMenu" class="user-menu-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                    <line x1="10" y1="8" x2="16" y2="8"></line>
                                    <line x1="10" y1="12" x2="16" y2="12"></line>
                                    <line x1="10" y1="16" x2="14" y2="16"></line>
                                </svg>
                                <span>è¾æ›¸ã‚’åˆ‡ã‚Šæ›¿ãˆ</span>
                            </button>
                            <button id="settingsButtonMenu" class="user-menu-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"></path>
                                </svg>
                                <span>è¨­å®š</span>
                            </button>
                            <button id="clearEnvButton" class="user-menu-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18"></path>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                                    <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                                <span>ç’°å¢ƒã‚’ã‚¯ãƒªã‚¢</span>
                            </button>
                            <button id="downloadOfflineUser" class="user-menu-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                <span>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</span>
                            </button>
                            <div class="user-menu-divider"></div>
                            <button id="switchAccountButton" class="user-menu-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                <span>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆ</span>
                            </button>
                            <button id="logoutButton" class="user-menu-item logout">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                    <polyline points="16 17 21 12 16 7"></polyline>
                                    <line x1="21" y1="12" x2="9" y2="12"></line>
                                </svg>
                                <span>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
                            </button>
                            <div class="user-menu-divider"></div>
                            <a id="helpLinkUser" class="user-menu-item" href="/help.html" target="_blank">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9 9a3 3 0 1 1 5.2 2.2c-.7.7-1.2 1.1-1.2 2.3"></path>
                                    <line x1="12" y1="17" x2="12" y2="17"></line>
                                </svg>
                                <span>ãƒ˜ãƒ«ãƒ—</span>
                            </a>
                            <button id="installPWAUser" class="user-menu-item" style="display: none;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                <span>ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </header>

        <main class="main">
            <div id="loading-indicator" class="loading hidden" role="status" aria-live="polite">
                <div class="spinner" aria-hidden="true"></div>
                <p class="loading-text">èª­ã¿è¾¼ã¿ä¸­â€¦</p>
            </div>

            <section id="question" class="card game-card">
                <div class="word-container">
                    <h1 id="question-word" class="word" aria-live="polite"></h1>
                    <button id="tts-button" type="button" class="tts-button" title="ç™ºéŸ³ã‚’èã" aria-label="ç™ºéŸ³ã‚’èã">
                        <svg class="tts-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                            <path d="M4 9v6h3.5L12 18V6L7.5 9H4z"></path>
                            <path d="M16 12a2 2 0 01-1.17 1.83l-.33.12v-3.9l.33.12A2 2 0 0116 12z"></path>
                            <path d="M18.5 12a4.5 4.5 0 01-3.05 4.24l-.45.15v-1.66l.18-.08A2.9 2.9 0 0017 12a2.9 2.9 0 00-1.82-2.65l-.18-.07V7.62l.45.15A4.5 4.5 0 0118.5 12z"></path>
                        </svg>
                        <span class="sr-only">ç™ºéŸ³ã‚’èã</span>
                    </button>
                </div>
                <p id="question-meaning" class="meaning"></p>
                <p id="question-reading" class="reading"></p>
                <div class="romaji-line"><p id="question-romaji" class="romaji"></p><a href="/help.html#romaji" target="_blank" title="Romaji Help" aria-label="Romaji Help" class="romaji-help">?</a></div>
                <div id="empty-wrong-words" class="empty-state hidden" aria-live="polite">
                    <div class="empty-illustration" aria-hidden="true">ğŸ«§</div>
                    <h3>ã¾ã é–“é•ã„ãŒã‚ã‚Šã¾ã›ã‚“</h3>
                    <p>ç¾åœ¨ã®éŒ¯é¡Œæœ¬ã¯ç©ºã§ã™ã€‚ã¾ãšã¯é€šå¸¸ã®è¾æ›¸ã§ç·´ç¿’ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
                    <button id="backToDefaultDict" class="primary-button" type="button">æ—¢å®šã®è¾æ›¸ã¸</button>
                </div>
                <form id="answer-form" class="answer-form" autocomplete="off">
                    <!-- è¾“å…¥æ¨¡å¼ -->
                    <div id="input-mode-container" class="mode-container">
                        <label class="sr-only" for="answer-input">ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</label>
                        <input id="answer-input" type="text" inputmode="text" autocomplete="off" placeholder="">
                    </div>
                    
                    <!-- æ‹¼è¯æ¨¡å¼ -->
                    <div id="puzzle-mode-container" class="mode-container hidden">
                        <div id="puzzle-answer-area" class="puzzle-answer-area">
                            <!-- ç”¨æˆ·é€‰æ‹©çš„å­—ç¬¦ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                        </div>
                        <div id="puzzle-options-area" class="puzzle-options-area">
                            <!-- æ‰“ä¹±çš„å‡åæ–¹å—ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                        </div>
                    </div>
                    
                    <div class="actions">
                        <button type="submit" id="answer-submit">ç­”ãˆã‚‹</button>
                        <button type="button" id="skip-button" class="skip-button" title="ã“ã®å•é¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—">ã‚¹ã‚­ãƒƒãƒ—</button>
                        <button type="button" id="replay-button" class="hidden">é‡å¬</button>
                        <button type="button" id="next-button" class="hidden">æ¬¡ã¸</button>
                    </div>
                </form>
            </section>
            <!-- æ¸¸æˆåŒ–è¿›åº¦é¢æ¿ -->
            <section class="game-progress-panel" aria-label="å­¦ç¿’é€²æ—" style="display: none;">
                <div class="player-stats">
                    <div class="player-avatar">
                        <div class="avatar-ring level-1">
                            <div class="avatar-icon" id="game-avatar-container">
                                <img id="gameUserAvatar" class="game-user-avatar hidden" src="" alt="User">
                                <span id="gameDefaultAvatar" class="game-default-avatar">âš”ï¸</span>
                            </div>
                        </div>
                        <div class="level-badge" id="level-badge">Lv.1</div>
                    </div>
                    
                    <div class="player-info">
                        <div class="exp-container">
                            <div class="exp-header">
                                <span class="exp-label">çµŒé¨“å€¤</span>
                                <button id="progress-reset" class="progress-reset-btn" type="button" title="é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆ">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                                        <path d="M3 3v5h5"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="exp-bar-wrapper">
                                <div id="exp-bar" class="exp-bar" role="progressbar">
                                    <div id="exp-fill" class="exp-bar-fill"></div>
                                    <div class="exp-bar-shine"></div>
                                </div>
                                <div class="exp-text" id="exp-text">0 / 100</div>
                            </div>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-item stat-correct">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                </svg>
                                <span class="stat-value" id="correct-stat">0</span>
                            </div>
                            <div class="stat-item stat-wrong">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="15" y1="9" x2="9" y2="15"></line>
                                    <line x1="9" y1="9" x2="15" y2="15"></line>
                                </svg>
                                <span class="stat-value" id="wrong-stat">0</span>
                            </div>
                            <div class="stat-item stat-combo">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                                </svg>
                                <span class="stat-value" id="combo-stat">0</span>
                            </div>
                            <div class="stat-item stat-total">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                </svg>
                                <span class="stat-value" id="total-stat">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="progress-text-info" id="progress-text-info">
                    <span id="progress-fraction">0 / 0</span>
                    <span class="progress-percentage" id="progress-percentage">0%</span>
                    <span id="dictionary-name" class="dictionary-name"></span>
                </div>
            </section>
        </main>

        <footer class="footer">
            Â© <a href="https://iamcheyan.com/" target="_blank" rel="noreferrer noopener">Cheyan</a> All Rights Reserved Â·
            <a href="https://github.com/iamcheyan/terebi" target="_blank" rel="noreferrer noopener" class="footer-link" aria-label="GitHub" title="GitHub">
                <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" fill="currentColor"><path d="M12 .5a11.5 11.5 0 0 0-3.64 22.42c.58.11.8-.25.8-.56v-2.02c-3.26.71-3.95-1.4-3.95-1.4-.53-1.36-1.3-1.72-1.3-1.72-1.06-.72.08-.71.08-.71 1.18.08 1.8 1.21 1.8 1.21 1.04 1.79 2.73 1.27 3.4.97.11-.76.41-1.27.75-1.56-2.6-.3-5.33-1.3-5.33-5.8 0-1.28.46-2.32 1.21-3.14-.12-.3-.52-1.52.11-3.17 0 0 .98-.31 3.2 1.2.94-.26 1.95-.39 2.95-.39s2.01.13 2.95.39c2.22-1.51 3.19-1.2 3.19-1.2.64 1.65.24 2.87.12 3.17.76.82 1.21 1.86 1.21 3.14 0 4.51-2.73 5.5-5.34 5.79.42.36.8 1.08.8 2.18v3.23c0 .31.21.68.81.56A11.5 11.5 0 0 0 12 .5Z"></path></svg>
                <span class="footer-link-label">GitHub</span>
            </a>
        </footer>
    </div>

    <!-- å…¨å±€alertså®¹å™¨ -->
    <section id="alerts" class="alerts" aria-live="polite"></section>

    <div id="modal-backdrop" class="modal-backdrop hidden" data-close="modal"></div>

    <div id="dictionary-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="dictionary-modal-title">
        <div class="modal-header">
            <h2 id="dictionary-modal-title">è¾æ›¸é¸æŠ</h2>
            <button type="button" class="modal-close" data-close="modal" aria-label="é–‰ã˜ã‚‹">Ã—</button>
        </div>
        <div class="modal-body dictionary-modal-body">
            <div class="dictionary-select-group">
                <label for="dictionary-select">åˆ©ç”¨ã™ã‚‹è¾æ›¸ã‚’é¸æŠ</label>
                <select id="dictionary-select"></select>
            </div>
            <div class="voice-selection">
                <label for="voice-select">éŸ³å£°é¸æŠ:</label>
                <select id="voice-select">
                    <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
                </select>
                <button type="button" id="voice-preview" class="ghost-button" title="é¸æŠä¸­ã®éŸ³å£°ã§è©¦è´ã—ã¾ã™" aria-label="éŸ³å£°ã‚’è©¦è´">â–¶ï¸ è©¦è´</button>
            </div>
            <div class="rate-control">
                <label for="rate-slider">èª­ã¿ä¸Šã’é€Ÿåº¦:</label>
                <div class="rate-control__track">
                    <input id="rate-slider" type="range" min="0.5" max="2" step="0.1" value="1" />
                    <span id="rate-value">1.0x</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="ghost-button" data-close="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button type="button" id="dictionary-save">ç¢ºèª</button>
        </div>
    </div>

    <div id="settings-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="settings-modal-title">
        <div class="modal-header">
            <h2 id="settings-modal-title">è¨­å®š</h2>
            <button type="button" class="modal-close" data-close="modal" aria-label="é–‰ã˜ã‚‹">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="settings-checkbox-grid">
                <label class="checkbox">
                    <input type="checkbox" id="toggle-reading" checked>
                    èª­ã¿æ–¹ã‚’è¡¨ç¤ºã™ã‚‹
                </label>
                <label class="checkbox">
                    <input type="checkbox" id="toggle-romaji" checked>
                    ãƒ­ãƒ¼ãƒå­—ã‚’è¡¨ç¤ºã™ã‚‹
                </label>
                <label class="checkbox">
                    <input type="checkbox" id="toggle-placeholder" checked>
                    å…¥åŠ›ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤ºã™ã‚‹
                </label>
                <label class="checkbox">
                    <input type="checkbox" id="toggle-katakana">
                    ã‚«ã‚¿ã‚«ãƒŠã«ã‚‚æŒ¯ã‚Šä»®åã‚’è¡¨ç¤ºã™ã‚‹
                </label>
                <label class="checkbox">
                    <input type="checkbox" id="toggle-furigana" checked>
                    æŒ¯ã‚Šä»®åã‚’è¡¨ç¤ºã™ã‚‹
                </label>
                <label class="checkbox">
                    <input type="checkbox" id="toggle-auto-pronunciation">
                    è‡ªå‹•ç™ºéŸ³
                </label>
                <label class="checkbox">
                    <input type="checkbox" id="toggle-combo-sound" checked>
                    é€£æ’ƒéŸ³æ•ˆ
                </label>
                <label class="checkbox">
                    <input type="checkbox" id="toggle-sound-effects" checked>
                    åŠ¹æœéŸ³ï¼ˆæ­£è§£/å ±é…¬ï¼‰
                </label>
                <label class="checkbox">
                    <input type="checkbox" id="toggle-haptics" checked>
                    è§¦æ„Ÿï¼ˆå¯¾å¿œãƒ‡ãƒã‚¤ã‚¹ï¼‰
                </label>
                <div class="sound-test-section" style="display: none;">
                    <button type="button" id="test-combo-sound" class="ghost-button">
                        ğŸ”Š éŸ³æ•ˆãƒ†ã‚¹ãƒˆ
                    </button>
                    <div class="combo-sound-tests">
                        <h4>é€£æ’ƒéŸ³æ•ˆãƒ†ã‚¹ãƒˆ</h4>
                        <div class="combo-test-buttons">
                            <button type="button" class="combo-test-btn" data-combo="3">3é€£æ’ƒ ğŸ”¥</button>
                            <button type="button" class="combo-test-btn" data-combo="5">5é€£æ’ƒ âœ¨</button>
                            <button type="button" class="combo-test-btn" data-combo="10">10é€£æ’ƒ ğŸ‰</button>
                            <button type="button" class="combo-test-btn" data-combo="20">20é€£æ’ƒ ğŸŒŸ</button>
                            <button type="button" class="combo-test-btn" data-combo="30">30é€£æ’ƒ ğŸ¦„</button>
                            <button type="button" class="combo-test-btn" data-combo="50">50é€£æ’ƒ ğŸ†</button>
                            <button type="button" class="combo-test-btn" data-combo="60">60é€£æ’ƒ ğŸ†</button>
                            <button type="button" class="combo-test-btn" data-combo="70">70é€£æ’ƒ ğŸ†</button>
                            <button type="button" class="combo-test-btn" data-combo="80">80é€£æ’ƒ ğŸ†</button>
                            <button type="button" class="combo-test-btn" data-combo="90">90é€£æ’ƒ ğŸ†</button>
                            <button type="button" class="combo-test-btn" data-combo="100">100é€£æ’ƒ ğŸ‘‘</button>
                            <button type="button" class="combo-test-btn" data-combo="200">200é€£æ’ƒ ğŸ’</button>
                            <button type="button" class="combo-test-btn" data-combo="300">300é€£æ’ƒ ğŸš€</button>
                            <button type="button" class="combo-test-btn" data-combo="500">500é€£æ’ƒ ğŸŒŒ</button>
                            <button type="button" class="combo-test-btn" data-combo="1000">1000é€£æ’ƒ ğŸ§™â€â™‚ï¸</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="ghost-button" data-close="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button type="button" id="settings-save">ç¢ºèª</button>
        </div>
    </div>

    <!-- é”™é¢˜æœ¬æŸ¥çœ‹é¢æ¿ -->
    <div id="wrong-words-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="wrong-words-modal-title">
        <div class="modal-header">
            <h2 id="wrong-words-modal-title">çµ±è¨ˆ</h2>
            <button type="button" class="modal-close" data-close="modal" aria-label="é–‰ã˜ã‚‹">Ã—</button>
        </div>
        <div class="modal-body wrong-words-body">
            <div class="wrong-words-stats">
                <div class="stat-card stat-correct">
                    <div class="stat-number" id="correct-count">0</div>
                    <div class="stat-label">æ­£è§£æ•°</div>
                </div>
                <div class="stat-card stat-wrong">
                    <div class="stat-number" id="wrong-count">0</div>
                    <div class="stat-label">éŒ¯é¡Œæ•°</div>
                </div>
            </div>
            <div class="wrong-words-actions">
                <button type="button" id="practice-wrong-words" class="ghost-button primary-button">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                    éŒ¯é¡Œã‚’ç·´ç¿’
                </button>
                <button type="button" id="clear-all-wrong-words" class="ghost-button danger-button" title="ã™ã¹ã¦ã‚¯ãƒªã‚¢">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </div>
            <div id="wrong-words-list" class="wrong-words-list">
                <!-- é”™é¢˜åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
            <div id="wrong-words-pagination" class="pagination hidden">
                <button id="prev-page" class="pagination-btn" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    å‰ã¸
                </button>
                <div class="pagination-info">
                    <span id="current-page">1</span> / <span id="total-pages">1</span>
                </div>
                <button id="next-page" class="pagination-btn" disabled>
                    æ¬¡ã¸
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Offline Download Modal -->
    <div id="offline-download-modal" class="modal hidden" role="dialog" aria-modal="true">
        <div class="modal-header">
            <h2>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä½¿ç”¨</h2>
            <button type="button" class="modal-close" data-close="offline-modal" aria-label="é–‰ã˜ã‚‹">Ã—</button>
        </div>
        <div class="modal-body">
            <p style="font-size: 14px; color: var(--text-secondary, #64748b); margin-bottom: 16px;">
                ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€å®Œå…¨ã«ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
            </p>
            <div id="offline-status" style="margin: 16px 0; font-size: 14px; text-align: center; min-height: 24px;">
                <!-- Status will be shown here -->
            </div>
            <button type="button" id="download-for-offline" class="ghost-button" style="width: 100%; margin-top: 8px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </button>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboard-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="leaderboard-modal-title">
                <div class="modal-header">
            <h2 id="leaderboard-modal-title">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
            <button type="button" class="modal-close" data-close="modal" aria-label="é–‰ã˜ã‚‹">Ã—</button>
        </div>
        <div class="modal-body leaderboard-body">
            <div class="leaderboard-stats">
                <div class="leaderboard-stat-card">
                    <div class="stat-number" id="my-rank">-</div>
                    <div class="stat-label">è‡ªåˆ†ã®é †ä½</div>
                </div>
                <div class="leaderboard-stat-card">
                    <div class="stat-number" id="my-score">0</div>
                    <div class="stat-label">è‡ªåˆ†ã®ã‚¹ã‚³ã‚¢</div>
                </div>
                <div class="leaderboard-stat-card">
                    <div class="stat-number" id="total-players">0</div>
                    <div class="stat-label">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°</div>
                </div>
            </div>
            
            <div class="leaderboard-actions" style="display:none;"></div>
            
            <div class="leaderboard-list" id="leaderboard-list">
                <div class="leaderboard-loading">
                    <div class="spinner" style="width: 24px; height: 24px; margin: 0 auto;"></div>
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>
            <div style="margin-top: 8px; text-align: right;">
                <button type="button" id="show-scoring-rules" class="ghost-button" title="è¨ˆç®—ãƒ«ãƒ¼ãƒ«">è¨ˆç®—ãƒ«ãƒ¼ãƒ«</button>
            </div>
            
            <div class="leaderboard-pagination" id="leaderboard-pagination" style="display: none;">
                <button id="prev-leaderboard-page" class="pagination-btn" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    å‰ã¸
                </button>
                <div class="pagination-info">
                    <span id="current-leaderboard-page">1</span> / <span id="total-leaderboard-pages">1</span>
                </div>
                <button id="next-leaderboard-page" class="pagination-btn" disabled>
                    æ¬¡ã¸
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- PWA Install Progress Modal -->
    <div id="pwa-install-modal" class="modal hidden" role="dialog" aria-modal="true">
        <div class="modal-header">
            <h2>ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</h2>
            <button type="button" class="modal-close" data-close="pwa-modal" aria-label="é–‰ã˜ã‚‹">Ã—</button>
        </div>
        <div class="modal-body">
            <div id="pwa-install-content">
                <div class="pwa-step" id="pwa-step-1">
                    <div class="pwa-icon">ğŸ“±</div>
                    <h3>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ä¸­...</h3>
                    <div class="pwa-progress">
                        <div class="pwa-progress-bar" id="pwa-progress-1" style="width: 0%"></div>
                    </div>
                    <p class="pwa-progress-text" id="pwa-progress-text-1">æº–å‚™ä¸­...</p>
                </div>
                <div class="pwa-step hidden" id="pwa-step-2">
                    <div class="pwa-icon">â¬‡ï¸</div>
                    <h3>ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...</h3>
                    <div class="pwa-progress">
                        <div class="pwa-progress-bar" id="pwa-progress-2" style="width: 0%"></div>
                    </div>
                    <p class="pwa-progress-text" id="pwa-progress-text-2">0 / 0 ãƒ•ã‚¡ã‚¤ãƒ«</p>
                </div>
                <div class="pwa-step hidden" id="pwa-step-3">
                    <div class="pwa-icon">âœ…</div>
                    <h3>ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†ï¼</h3>
                    <p>ã‚¢ãƒ—ãƒªã‚’ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã§ãã¾ã™</p>
                    <button type="button" id="pwa-add-to-home" class="primary-button" style="max-width: 100%; margin-top: 16px;">
                        ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ 
                    </button>
                </div>
                <div class="pwa-step hidden" id="pwa-step-error">
                    <div class="pwa-icon">âŒ</div>
                    <h3>ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ</h3>
                    <p id="pwa-error-message"></p>
                    <button type="button" class="ghost-button" data-close="pwa-modal" style="margin-top: 16px;">
                        é–‰ã˜ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, limit, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAOp_lGAlIBxP5pFQID_RPelmLE4NTvZ2s",
            authDomain: "kotoba-60aeb.firebaseapp.com",
            projectId: "kotoba-60aeb",
            storageBucket: "kotoba-60aeb.firebasestorage.app",
            messagingSenderId: "367445040315",
            appId: "1:367445040315:web:1b68e59976ac2ab1f91d9e",
            measurementId: "G-CT0R8S7TQG"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        // å¼ºåˆ¶æ˜¾ç¤ºè´¦æˆ·é€‰æ‹©ç•Œé¢
        provider.setCustomParameters({
            prompt: 'select_account'
        });

        // Make auth and db available globally
        window.firebaseAuth = auth;
        window.firebaseDb = db;

        // ç®€åŒ–ä¸ºä¸ Terebi ç›¸åŒçš„ç™»å½•æ–¹å¼ï¼šä»…ä½¿ç”¨ Popup

        // UI Elements
        const loginButton = document.getElementById('loginButton');
        const loginButtonMenu = document.getElementById('loginButtonMenu');
        const userProfile = document.getElementById('userProfile');
        const guestProfile = document.getElementById('guestProfile');
        const guestMenuTrigger = document.querySelector('.guest-menu-trigger');
        const guestMenu = document.getElementById('guestMenu');
        const userAvatar = document.getElementById('userAvatar');
        const userAvatarMenu = document.getElementById('userAvatarMenu');
        const userNameMenu = document.getElementById('userNameMenu');
        const userEmailMenu = document.getElementById('userEmailMenu');
        const userMenu = document.getElementById('userMenu');
        const logoutButton = document.getElementById('logoutButton');
        const syncDataButton = document.getElementById('syncDataButton');
        const switchAccountButton = document.getElementById('switchAccountButton');
        const dictionaryButtonMenuGuest = document.getElementById('dictionaryButtonMenuGuest');
        const settingsButtonMenuGuest = document.getElementById('settingsButtonMenuGuest');
        const clearEnvButtonGuest = document.getElementById('clearEnvButtonGuest');
        const headerLeaderboardBtn = document.getElementById('headerLeaderboardBtn');
        const submitScoreButton = document.getElementById('submit-score-button');
        const refreshLeaderboardButton = document.getElementById('refresh-leaderboard');
        const clearEnvButton = document.getElementById('clearEnvButton');

        // Toggle guest menu
        if (guestMenuTrigger) {
            guestMenuTrigger.addEventListener('click', (e) => {
                e.stopPropagation();
                if (guestMenu) guestMenu.classList.toggle('show');
            });
        }

        // Toggle user menu
        if (userAvatar) {
            userAvatar.addEventListener('click', (e) => {
                e.stopPropagation();
                if (userMenu) userMenu.classList.toggle('show');
            });
        }

        // Close menu when clicking outside
        document.addEventListener('click', () => {
            if (userMenu) userMenu.classList.remove('show');
            if (guestMenu) guestMenu.classList.remove('show');
        });

        // ç»Ÿä¸€å…³é—­é€»è¾‘ï¼ˆç©ºç™½é®ç½©/é€šç”¨å…³é—­æŒ‰é’®ï¼‰
        function closeAllModals() {
            const openModalIds = [
                'dictionary-modal',
                'settings-modal',
                'wrong-words-modal',
                'offline-download-modal',
                'pwa-install-modal',
                'leaderboard-modal'
            ];
            openModalIds.forEach((id) => {
                const el = document.getElementById(id);
                if (el && !el.classList.contains('hidden')) {
                    el.classList.add('hidden');
                }
            });
            const backdrop = document.getElementById('modal-backdrop');
            if (backdrop) backdrop.classList.add('hidden');
        }

        // ç©ºç™½ã®é ˜åŸŸã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°å«ã‚€ï¼‰
        const globalBackdrop = document.getElementById('modal-backdrop');
        if (globalBackdrop) {
            globalBackdrop.addEventListener('click', closeAllModals);
        }

        // å…±é€šé–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ï¼ˆdata-close="modal"ï¼‰ã‚‚åŒã˜ãƒ­ã‚¸ãƒƒã‚¯
        document.querySelectorAll('[data-close="modal"]').forEach((btn) => {
            btn.addEventListener('click', closeAllModals);
        });

        // Esc to close modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modals = ['dictionary-modal','settings-modal','wrong-words-modal','offline-download-modal','pwa-install-modal','leaderboard-modal'];
                const backdrop = document.getElementById('modal-backdrop');
                let closed = false;
                modals.forEach(id => {
                    const el = document.getElementById(id);
                    if (el && !el.classList.contains('hidden')) {
                        el.classList.add('hidden');
                        closed = true;
                    }
                });
                if (closed && backdrop) backdrop.classList.add('hidden');
            }
        });

        // Prevent menu from closing when clicking inside
        if (userMenu) {
            userMenu.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }
        
        if (guestMenu) {
            guestMenu.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }
        
        // Guest menu actions
        if (loginButtonMenu) {
            loginButtonMenu.addEventListener('click', async () => {
                try {
                    sessionStorage.removeItem('dataLoaded');
                    const result = await signInWithPopup(auth, provider);
                    const user = result.user;
                    console.log('User signed in:', user.displayName);
                    showNotification('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ', 'success');
                    if (guestMenu) guestMenu.classList.remove('show');
                } catch (error) {
                    console.error('Login error:', error);
                    showNotification('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                }
            });
        }
        
        if (dictionaryButtonMenuGuest) {
            dictionaryButtonMenuGuest.addEventListener('click', function() {
                const dictionaryModal = document.getElementById('dictionary-modal');
                const backdrop = document.getElementById('modal-backdrop');
                if (dictionaryModal) {
                    dictionaryModal.classList.remove('hidden');
                }
                if (backdrop) {
                    backdrop.classList.remove('hidden');
                }
                if (guestMenu) guestMenu.classList.remove('show');
            });
        }
        
        if (settingsButtonMenuGuest) {
            settingsButtonMenuGuest.addEventListener('click', function() {
                const settingsModal = document.getElementById('settings-modal');
                const backdrop = document.getElementById('modal-backdrop');
                if (settingsModal) {
                    settingsModal.classList.remove('hidden');
                }
                if (backdrop) {
                    backdrop.classList.remove('hidden');
                }
                if (guestMenu) guestMenu.classList.remove('show');
            });
        }

        // Clear environment (guest)
        if (clearEnvButtonGuest) {
            clearEnvButtonGuest.addEventListener('click', function() {
                if (guestMenu) guestMenu.classList.remove('show');
                window.location.href = '/clear.html';
            });
        }

        // Removed user-menu leaderboard button

        // Header leaderboard entry
        if (headerLeaderboardBtn) {
            headerLeaderboardBtn.addEventListener('click', async function() {
                // æ‰“å¼€å‰å…ˆæäº¤å½“å‰åˆ†æ•°ï¼Œç¡®ä¿æ’è¡Œæ¦œå­˜çš„æ˜¯æœ€æ–°æ•°æ®
                try {
                    await submitScoreToLeaderboard({ silent: true });
                } catch (e) { console.warn('é¢„æäº¤å¤±è´¥', e); }

                const leaderboardModal = document.getElementById('leaderboard-modal');
                const backdrop = document.getElementById('modal-backdrop');
                if (leaderboardModal) leaderboardModal.classList.remove('hidden');
                if (backdrop) backdrop.classList.remove('hidden');
                if (guestMenu) guestMenu.classList.remove('show');
                if (userMenu) userMenu.classList.remove('show');
                await loadLeaderboard();
            });
        }

        // Clear environment (user)
        if (clearEnvButton) {
            clearEnvButton.addEventListener('click', function() {
                if (userMenu) userMenu.classList.remove('show');
                window.location.href = '/clear.html';
            });
        }

        // Submit score button
        if (submitScoreButton) {
            submitScoreButton.addEventListener('click', async function() {
                await submitScoreToLeaderboard();
            });
        }

        // Refresh leaderboard button
        if (refreshLeaderboardButton) {
            refreshLeaderboardButton.addEventListener('click', async function() {
                await loadLeaderboard();
            });
        }

        // Show scoring rules (æ—¥æœ¬èª) - open in new tab
        const showScoringRulesBtn = document.getElementById('show-scoring-rules');
        if (showScoringRulesBtn) {
            showScoringRulesBtn.addEventListener('click', () => {
                window.open('/help.html#scoring', '_blank', 'noopener');
            });
        }

        // cleanup-leaderboard removed

        // Leaderboard pagination
        const prevLeaderboardPage = document.getElementById('prev-leaderboard-page');
        const nextLeaderboardPage = document.getElementById('next-leaderboard-page');
        
        if (prevLeaderboardPage) {
            prevLeaderboardPage.addEventListener('click', function() {
                if (currentLeaderboardPage > 1) {
                    currentLeaderboardPage--;
                    displayLeaderboard();
                }
            });
        }
        
        if (nextLeaderboardPage) {
            nextLeaderboardPage.addEventListener('click', function() {
                const totalPages = Math.ceil(leaderboardData.length / leaderboardPageSize);
                if (currentLeaderboardPage < totalPages) {
                    currentLeaderboardPage++;
                    displayLeaderboard();
                }
            });
        }

        // Login with Google
        if (loginButton) {
            loginButton.addEventListener('click', async () => {
                try {
                    sessionStorage.removeItem('dataLoaded');
                    const result = await signInWithPopup(auth, provider);
                    const user = result.user;
                    console.log('User signed in:', user.displayName);
                    showNotification('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ', 'success');
                } catch (error) {
                    console.error('Login error:', error);
                    showNotification('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                }
            });
        }

        // Logout
        if (logoutButton) {
            logoutButton.addEventListener('click', async () => {
                try {
                    // æ¸…é™¤æœ¬åœ°ç§¯åˆ†ä¿¡æ¯ï¼Œé¿å…è´¦å·åˆ‡æ¢æ—¶æ²¿ç”¨
                    (function clearLocalScore() {
                        ['correct','wrong','combo','total'].forEach((k) => {
                            try { localStorage.removeItem(k); } catch (_) {}
                        });
                        if (window.updateScoreboard) {
                            try { window.updateScoreboard(); } catch (_) {}
                        }
                    })();

                    await signOut(auth);
                    console.log('User signed out');
                    showNotification('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'success');
                } catch (error) {
                    console.error('Logout error:', error);
                    showNotification('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                }
            });
        }

        // Switch account
        if (switchAccountButton) {
            switchAccountButton.addEventListener('click', async () => {
                try {
                    sessionStorage.removeItem('dataLoaded');
                    // å…ˆæ¸…é™¤æœ¬åœ°ç§¯åˆ†ï¼Œé˜²æ­¢åˆ‡æ¢è´¦æˆ·åç»§æ‰¿
                    ['correct','wrong','combo','total'].forEach((k) => {
                        try { localStorage.removeItem(k); } catch (_) {}
                    });
                    if (window.updateScoreboard) {
                        try { window.updateScoreboard(); } catch (_) {}
                    }
                    await signOut(auth);
                    setTimeout(async () => {
                        try {
                            const result = await signInWithPopup(auth, provider);
                            const user = result.user;
                            console.log('Switched to account:', user.displayName);
                            showNotification('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ', 'success');
                        } catch (error) {
                            console.error('Switch account error:', error);
                            showNotification('åˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                        }
                    }, 100);
                } catch (error) {
                    console.error('Logout error during switch:', error);
                }
            });
        }

        // Sync data to Firestore
        async function syncUserData(user) {
            if (!user) return;

            try {
                const userRef = doc(db, 'users', user.uid);
                
                const localData = {
                    // å­¦ä¹ è¿›åº¦
                    correct: parseInt(localStorage.getItem('correct') || '0', 10),
                    wrong: parseInt(localStorage.getItem('wrong') || '0', 10),
                    
                    // æ¸¸æˆåŒ–æ•°æ®
                    combo: parseInt(localStorage.getItem('combo') || '0', 10),
                    total: parseInt(localStorage.getItem('total') || '0', 10),
                    
                    // ä»…ä¸ŠæŠ¥è®¡æ•°ï¼Œé¿å…è¶…å‡º 1MB æ–‡æ¡£é™åˆ¶
                    masteredCount: (() => { try { return Object.keys(JSON.parse(localStorage.getItem('masteredEntries') || '{}')).length; } catch { return 0; } })(),
                    wrongWordsCount: (() => { try { return (JSON.parse(localStorage.getItem('wrongWords') || '[]') || []).length; } catch { return 0; } })(),
                    
                    // ç”¨æˆ·åå¥½
                    lastSelectedDictionary: localStorage.getItem('lastSelectedDictionary'),
                    selectedVoice: localStorage.getItem('selectedVoice'),
                    speechRate: localStorage.getItem('speechRate'),
                    theme: localStorage.getItem('kotoba.theme'),
                    answerMode: localStorage.getItem('answerMode') || 'input',
                    
                    // åŒæ­¥æ—¶é—´
                    lastSync: new Date().toISOString(),
                    
                    // ç”¨æˆ·ä¿¡æ¯
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL
                };

                await setDoc(userRef, localData, { merge: true });
                    console.log('âœ… ã‚¯ãƒ©ã‚¦ãƒ‰ã¸åŒæœŸã—ã¾ã—ãŸ');
                    console.log('ğŸ“Š åŒæœŸãƒ‡ãƒ¼ã‚¿:', {
                        æ­£è§£: localData.correct,
                        èª¤ç­”: localData.wrong,
                        é€£æ’ƒ: localData.combo,
                        ç·å•é¡Œæ•°: localData.total,
                        ç¿’å¾—æ¸ˆã¿: localData.masteredCount,
                        éŒ¯é¡Œæœ¬: localData.wrongWordsCount
                    });

                // åŒæ­¥æˆåŠŸåä¹Ÿè½»é‡æ›´æ–°æ’è¡Œæ¦œï¼ˆé™é»˜ï¼‰
                try {
                    await submitScoreToLeaderboard({ silent: true });
                } catch (e) {
                    console.warn('é™é»˜æ›´æ–°æ’è¡Œæ¦œå¤±è´¥:', e);
                }
            } catch (error) {
                console.error('âŒ åŒæ­¥æ•°æ®å¤±è´¥:', error);
                throw error;
            }
        }

        // Load user data from Firestore
        async function loadUserData(user, options = {}) {
            if (!user) return;
            
            const { silent = false } = options;

            try {
                const userRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userRef);

                if (userDoc.exists()) {
                    const cloudData = userDoc.data();
                    console.log('ğŸ“¥ æ­£åœ¨ä»äº‘ç«¯åŠ è½½æ•°æ®...');
                    
                    // åŒæ­¥å­¦ä¹ è¿›åº¦
                    if (cloudData.correct !== undefined) {
                        localStorage.setItem('correct', String(cloudData.correct));
                    }
                    if (cloudData.wrong !== undefined) {
                        localStorage.setItem('wrong', String(cloudData.wrong));
                    }
                    
                    // åŒæ­¥æ¸¸æˆåŒ–æ•°æ®
                    if (cloudData.combo !== undefined) {
                        localStorage.setItem('combo', String(cloudData.combo));
                    }
                    if (cloudData.total !== undefined) {
                        localStorage.setItem('total', String(cloudData.total));
                    }
                    
                    // ä¸å†ä»äº‘ç«¯è¦†ç›– masteredEntries å…·ä½“åˆ—è¡¨ï¼ˆé¿å…å¤§å¯¹è±¡ï¼‰ï¼Œä»…ä¿ç•™æœ¬åœ°
                    
                    // åŒæ­¥é”™é¢˜æœ¬ - åˆå¹¶å»é‡
                    // ä¸å†ä»äº‘ç«¯åŒæ­¥ wrongWords åˆ—è¡¨ï¼Œé¿å…è†¨èƒ€ï¼›ä»å¯ä½¿ç”¨è®¡æ•°
                    
                    // åŒæ­¥ç”¨æˆ·åå¥½
                    if (cloudData.lastSelectedDictionary) {
                        localStorage.setItem('lastSelectedDictionary', cloudData.lastSelectedDictionary);
                    }
                    if (cloudData.selectedVoice) {
                        localStorage.setItem('selectedVoice', cloudData.selectedVoice);
                    }
                    if (cloudData.speechRate) {
                        localStorage.setItem('speechRate', cloudData.speechRate);
                    }
                    if (cloudData.theme) {
                        localStorage.setItem('kotoba.theme', cloudData.theme);
                    }
                    if (cloudData.answerMode) {
                        localStorage.setItem('answerMode', cloudData.answerMode);
                    }

                    console.log('ğŸ‰ æ•°æ®åŠ è½½å®Œæˆï¼');
                    console.log('ğŸ“Š åŠ è½½çš„æ•°æ®:', {
                        æ­£ç¡®: cloudData.correct,
                        é”™è¯¯: cloudData.wrong,
                        è¿å‡»: cloudData.combo,
                        æ€»é¢˜æ•°: cloudData.total,
                        å·²æŒæ¡: cloudData.masteredEntries ? Object.keys(cloudData.masteredEntries).length : 0,
                        é”™é¢˜æœ¬: cloudData.wrongWords ? cloudData.wrongWords.length : 0
                    });
                    sessionStorage.setItem('dataLoaded', 'true');
                    
                    if (!silent) {
                        showNotification('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
                    }
                    
                    // åˆ·æ–°ç•Œé¢
                    if (window.updateScoreboard) {
                        window.updateScoreboard();
                    }
                } else {
                    // é¦–æ¬¡ç™»å½•ï¼Œä¸Šä¼ æœ¬åœ°æ•°æ®
                    console.log('ğŸ“¤ é¦–æ¬¡ç™»å½•ï¼Œæ­£åœ¨ä¸Šä¼ æœ¬åœ°æ•°æ®...');
                    await syncUserData(user);
                    sessionStorage.setItem('dataLoaded', 'true');
                }
            } catch (error) {
                console.error('âŒ åŠ è½½æ•°æ®å¤±è´¥:', error);
            }
        }

        // Sync data button
        if (syncDataButton) {
            syncDataButton.addEventListener('click', async () => {
                const user = auth.currentUser;
                if (user) {
                    try {
                        console.log('ğŸ”„ å¼€å§‹åŒæ­¥...');
                        await loadUserData(user, { silent: true });
                        await syncUserData(user);
                        showNotification('ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¾ã—ãŸ', 'success');
                        
                        // åˆ·æ–°ç•Œé¢
                        if (window.updateScoreboard) {
                            window.updateScoreboard();
                        }
                        console.log('âœ… åŒæ­¥å®Œæˆ');
                    } catch (error) {
                        console.error('Sync error:', error);
                        showNotification('åŒæœŸã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                    }
                }
            });
        }

        // Auth state observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log('User is signed in:', user.displayName);
                
                // Update UI - æ˜¾ç¤ºå·²ç™»å½•çŠ¶æ€
                if (guestProfile) guestProfile.style.display = 'none';
                if (userProfile) userProfile.style.display = 'flex';
                if (userAvatar) userAvatar.src = user.photoURL || '';
                if (userAvatarMenu) userAvatarMenu.src = user.photoURL || '';
                if (userNameMenu) userNameMenu.textContent = user.displayName || 'User';
                if (userEmailMenu) userEmailMenu.textContent = user.email || '';
                if (guestMenu) guestMenu.classList.remove('show');

                // æ˜¾ç¤ºæ’è¡Œæ¦œç»Ÿè®¡ä¸æ“ä½œåŒºåŸŸï¼ˆä»…ç™»å½•æ—¶ï¼‰
                const leaderboardStats = document.querySelector('.leaderboard-stats');
                const leaderboardActions = document.querySelector('.leaderboard-actions');
                if (leaderboardStats) leaderboardStats.style.display = 'grid';
                if (leaderboardActions) leaderboardActions.style.display = 'none';
                
                // æ›´æ–°æ¸¸æˆé¢æ¿å¤´åƒ
                const gameUserAvatar = document.getElementById('gameUserAvatar');
                const gameDefaultAvatar = document.getElementById('gameDefaultAvatar');
                if (gameUserAvatar && user.photoURL) {
                    gameUserAvatar.src = user.photoURL;
                    gameUserAvatar.classList.remove('hidden');
                    if (gameDefaultAvatar) gameDefaultAvatar.classList.add('hidden');
                }

                // Load user data
                const dataLoaded = sessionStorage.getItem('dataLoaded');
                if (dataLoaded !== 'true') {
                    await loadUserData(user);
                }
                
                // åˆ·æ–°å­—å…¸åˆ—è¡¨ä»¥æ˜¾ç¤ºé”™é¢˜æœ¬
                if (window.populateDictionarySelect) {
                    window.populateDictionarySelect();
                }
                
                // æ˜¾ç¤ºè¿›åº¦æ¡å’Œæ¸¸æˆé¢æ¿
                const progressTextInfo = document.getElementById('progress-text-info');
                if (progressTextInfo) progressTextInfo.style.display = 'flex';
                
                const gameProgressPanel = document.querySelector('.game-progress-panel');
                if (gameProgressPanel) gameProgressPanel.style.display = 'block';

                // æ˜¾ç¤ºæ’è¡Œæ¦œå…¥å£æŒ‰é’®
                if (headerLeaderboardBtn) headerLeaderboardBtn.style.display = 'inline-flex';
            } else {
                console.log('User is signed out');
                sessionStorage.removeItem('dataLoaded');
                // è´¦å·å·²ç™»å‡ºï¼šæ¸…é™¤æœ¬åœ°ç§¯åˆ†ä¿¡æ¯
                ['correct','wrong','combo','total'].forEach((k) => {
                    try { localStorage.removeItem(k); } catch (_) {}
                });
                if (window.updateScoreboard) {
                    try { window.updateScoreboard(); } catch (_) {}
                }
                
                // Update UI - æ˜¾ç¤ºæœªç™»å½•çŠ¶æ€
                if (guestProfile) guestProfile.style.display = 'flex';
                if (userProfile) userProfile.style.display = 'none';
                if (userMenu) userMenu.classList.remove('show');
                if (guestMenu) guestMenu.classList.remove('show');

                // éšè—æ’è¡Œæ¦œç»Ÿè®¡ä¸æ“ä½œåŒºåŸŸï¼ˆæœªç™»å½•ï¼‰
                const leaderboardStats = document.querySelector('.leaderboard-stats');
                const leaderboardActions = document.querySelector('.leaderboard-actions');
                if (leaderboardStats) leaderboardStats.style.display = 'none';
                if (leaderboardActions) leaderboardActions.style.display = 'none';
                
                // æ¢å¤æ¸¸æˆé¢æ¿é»˜è®¤å¤´åƒ
                const gameUserAvatar = document.getElementById('gameUserAvatar');
                const gameDefaultAvatar = document.getElementById('gameDefaultAvatar');
                if (gameUserAvatar) {
                    gameUserAvatar.classList.add('hidden');
                    gameUserAvatar.src = '';
                }
                if (gameDefaultAvatar) gameDefaultAvatar.classList.remove('hidden');
                
                // åˆ·æ–°å­—å…¸åˆ—è¡¨ä»¥éšè—é”™é¢˜æœ¬
                if (window.populateDictionarySelect) {
                    window.populateDictionarySelect();
                }
                
                // éšè—è¿›åº¦æ¡å’Œæ¸¸æˆé¢æ¿
                const progressTextInfo = document.getElementById('progress-text-info');
                if (progressTextInfo) progressTextInfo.style.display = 'none';
                
                const gameProgressPanel = document.querySelector('.game-progress-panel');
                if (gameProgressPanel) gameProgressPanel.style.display = 'none';

                // éšè—æ’è¡Œæ¦œå…¥å£æŒ‰é’®
                if (headerLeaderboardBtn) headerLeaderboardBtn.style.display = 'none';
            }
        });

        // Leaderboard functionality
        let leaderboardData = [];
        let currentLeaderboardPage = 1;
        const leaderboardPageSize = 5;

        // Submit score to leaderboard
        async function submitScoreToLeaderboard(options = {}) {
            const { silent = false } = options;
            const user = auth.currentUser;
            if (!user) {
                if (!silent) showNotification('ã¾ãšã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            try {
                // è®¡ç®—æ€»åˆ†ï¼šæ­£ç¡®æ•° * 10 + è¿å‡»æ•° * 5 + æ€»é¢˜æ•° * 2
                const correct = parseInt(localStorage.getItem('correct') || '0', 10);
                const wrong = parseInt(localStorage.getItem('wrong') || '0', 10);
                const combo = parseInt(localStorage.getItem('combo') || '0', 10);
                // ä»¥å½“å‰æ­£ç¡®+é”™è¯¯è®¡ç®—æ€»é¢˜æ•°ï¼Œé¿å… localStorage.total ä¸ºç©ºæˆ–è¿‡æœŸ
                const total = correct + wrong;
                const score = correct * 10 + combo * 5 + total * 2;

                if (score === 0) {
                    if (!silent) showNotification('ç¾åœ¨ã®ã‚¹ã‚³ã‚¢ãŒ 0 ã®ãŸã‚é€ä¿¡ã§ãã¾ã›ã‚“', 'error');
                    return;
                }

                // ä»¥ uid ä½œä¸ºæ–‡æ¡£ IDï¼Œè¦†ç›–è¯¥ç”¨æˆ·çš„æ’è¡Œæ¦œè®°å½•
                await setDoc(doc(db, 'leaderboard', user.uid), {
                    uid: user.uid,
                    displayName: user.displayName || 'Anonymous',
                    photoURL: user.photoURL || '',
                    score: score,
                    correct: correct,
                    wrong: wrong,
                    combo: combo,
                    total: total,
                    submittedAt: serverTimestamp()
                });

                // æäº¤åç«‹å³è¯»å–éªŒè¯ï¼ˆç¡®è®¤å†™å…¥åˆ°æœ¬é¡¹ç›®/æœ¬é›†åˆï¼‰
                try {
                    const meRef = doc(db, 'leaderboard', user.uid);
                    const meSnap = await getDoc(meRef);
                    console.log('âœ… æäº¤åè¯»å–éªŒè¯:', {
                        exists: meSnap.exists(),
                        id: meSnap.id,
                        data: meSnap.exists() ? meSnap.data() : null
                    });
                } catch (verifyErr) {
                    console.warn('æäº¤åè¯»å–éªŒè¯å¤±è´¥:', verifyErr);
                }

                if (!silent) showNotification('ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ã‚¹ã‚³ã‚¢ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼', 'success');
                
                // åˆ·æ–°æ’è¡Œæ¦œ
                await loadLeaderboard();
            } catch (error) {
                console.error('æäº¤åˆ†æ•°å¤±è´¥:', error);
                if (!silent) showNotification('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        // Load leaderboard data
        async function loadLeaderboard() {
            try {
                const leaderboardList = document.getElementById('leaderboard-list');
                if (leaderboardList) {
                    leaderboardList.innerHTML = `
                        <div class="leaderboard-loading">
                            <div class="spinner" style="width: 24px; height: 24px; margin: 0 auto;"></div>
                            <p>åŠ è½½ä¸­...</p>
                        </div>
                    `;
                }

                // æŸ¥è¯¢æ’è¡Œæ¦œæ•°æ®ï¼ŒæŒ‰åˆ†æ•°é™åºæ’åˆ—
                const leaderboardQuery = query(
                    collection(db, 'leaderboard'),
                    orderBy('score', 'desc'),
                    limit(100) // å…ˆå–æ›´å¤šï¼Œé¿å…åŒä¸€ç”¨æˆ·å æ»¡
                );
                
                const snapshot = await getDocs(leaderboardQuery);
                leaderboardData = [];
                
                snapshot.forEach(doc => {
                    leaderboardData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                console.log('ğŸ“Š æŸ¥è¯¢åˆ°çš„åŸå§‹æ•°æ®:', leaderboardData.length, 'æ¡è®°å½•');
                console.log('ğŸ“Š ç”¨æˆ·åˆ†å¸ƒ:', leaderboardData.map(entry => ({ uid: entry.uid, displayName: entry.displayName, score: entry.score })));

                // å…¼å®¹å†å²æ•°æ®ï¼šæŒ‰ uid å»é‡ï¼Œä»…ä¿ç•™æ¯ä¸ªç”¨æˆ·â€œæœ€æ–°æäº¤â€çš„ä¸€æ¡
                const byUserLatest = new Map();
                leaderboardData.forEach(entry => {
                    const current = byUserLatest.get(entry.uid);
                    const ts = (entry.submittedAt && entry.submittedAt.toMillis) ? entry.submittedAt.toMillis() : 0;
                    const curTs = current && current.submittedAt && current.submittedAt.toMillis ? current.submittedAt.toMillis() : -1;
                    if (!current || ts >= curTs) {
                        byUserLatest.set(entry.uid, entry);
                    }
                });

                // åªè®°å½•æ¯ä¸ªç”¨æˆ·æœ€æ–°ä¸€æ¡ï¼›æ˜¾ç¤ºæ—¶ä¸å†æˆªæ–­ä¸º10ä¸ª
                leaderboardData = Array.from(byUserLatest.values())
                    .sort((a, b) => b.score - a.score);
                
                console.log('ğŸ“Š å»é‡åçš„æ•°æ®:', leaderboardData.length, 'ä¸ªå”¯ä¸€ç”¨æˆ·');
                console.log('ğŸ“Š æœ€ç»ˆæ’è¡Œæ¦œ:', leaderboardData.map(entry => ({ uid: entry.uid, displayName: entry.displayName, score: entry.score })));

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                updateLeaderboardStats();
                
                // æ˜¾ç¤ºæ’è¡Œæ¦œ
                displayLeaderboard();
                
            } catch (error) {
                console.error('åŠ è½½æ’è¡Œæ¦œå¤±è´¥:', error);
                const leaderboardList = document.getElementById('leaderboard-list');
                if (leaderboardList) {
                    leaderboardList.innerHTML = `
                        <div class="leaderboard-empty">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2h-4"></path>
                                <path d="M9 11V9a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
                                <line x1="12" y1="15" x2="12" y2="17"></line>
                            </svg>
                    <p>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
                        </div>
                    `;
                }
                showNotification('ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        // Update leaderboard statistics
        function updateLeaderboardStats() {
            const user = auth.currentUser;
            if (!user) return;

            // æ›´æ–°æ€»ç©å®¶æ•°
            const totalPlayersEl = document.getElementById('total-players');
            if (totalPlayersEl) {
                totalPlayersEl.textContent = leaderboardData.length;
            }

            // æŸ¥æ‰¾å½“å‰ç”¨æˆ·æ’åå’Œåˆ†æ•°
            const userIndex = leaderboardData.findIndex(entry => entry.uid === user.uid);
            const myRankEl = document.getElementById('my-rank');
            const myScoreEl = document.getElementById('my-score');
            
            if (userIndex !== -1) {
                const userEntry = leaderboardData[userIndex];
                if (myRankEl) myRankEl.textContent = userIndex + 1;
                if (myScoreEl) myScoreEl.textContent = userEntry.score;
            } else {
                // ç”¨æˆ·ä¸åœ¨æ’è¡Œæ¦œä¸­ï¼Œæ˜¾ç¤ºå½“å‰æœ¬åœ°åˆ†æ•°
                const correct = parseInt(localStorage.getItem('correct') || '0', 10);
                const combo = parseInt(localStorage.getItem('combo') || '0', 10);
                const total = parseInt(localStorage.getItem('total') || '0', 10);
                const score = correct * 10 + combo * 5 + total * 2;
                
                if (myRankEl) myRankEl.textContent = '-';
                if (myScoreEl) myScoreEl.textContent = score;
            }
        }

        // Display leaderboard
        function calculateLevel(correctCount) {
            // ä¸åº”ç”¨å†…ç­‰çº§é€»è¾‘ä¿æŒä¸€è‡´ï¼šæ¯ 100 æ­£è§£ = 1 çº§ï¼Œèµ·å§‹ Lv.1
            return Math.floor((Number(correctCount) || 0) / 100) + 1;
        }

        function displayLeaderboard() {
            const leaderboardList = document.getElementById('leaderboard-list');
            if (!leaderboardList) return;

            if (leaderboardData.length === 0) {
                leaderboardList.innerHTML = `
                    <div class="leaderboard-empty">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2h-4"></path>
                            <path d="M9 11V9a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
                            <line x1="12" y1="15" x2="12" y2="17"></line>
                        </svg>
                        <p>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                `;
                return;
            }

            const user = auth.currentUser;
            const startIndex = (currentLeaderboardPage - 1) * leaderboardPageSize;
            const endIndex = Math.min(startIndex + leaderboardPageSize, leaderboardData.length);
            const pageData = leaderboardData.slice(startIndex, endIndex);

            let html = '';
            pageData.forEach((entry, index) => {
                const rank = startIndex + index + 1;
                const isCurrentUser = user && entry.uid === user.uid;
                
                let rankClass = '';
                if (rank === 1) rankClass = 'rank-1';
                else if (rank === 2) rankClass = 'rank-2';
                else if (rank === 3) rankClass = 'rank-3';
                else if (rank <= 10) rankClass = 'top-3';

                const level = calculateLevel(parseInt(entry.correct || 0, 10));
                const lastUpdated = entry.submittedAt && entry.submittedAt.toDate ? entry.submittedAt.toDate() : null;
                const lastBestText = lastUpdated ? new Date(lastUpdated).toLocaleString() : '';
                const title = entry.combo >= 50 ? 'ä¼èª¬ã®é€£æ’ƒ' : (entry.combo >= 20 ? 'é©šç•°ã®æŒ‘æˆ¦è€…' : (entry.combo >= 10 ? 'ç´ æ™´ã‚‰ã—ã„æŒ‘æˆ¦è€…' : 'æŒ‘æˆ¦è€…'));
                html += `
                    <div class="leaderboard-item ${isCurrentUser ? 'current-user' : ''}">
                        <div class="leaderboard-rank ${rankClass}">${rank}</div>
                        <div class="leaderboard-user">
                            <img src="${entry.photoURL || '/static/logo.svg'}" 
                                 alt="${entry.displayName}" 
                                 class="leaderboard-avatar"
                                 onerror="this.src='/static/logo.svg'">
                            <div class="leaderboard-user-info">
                                <div class="leaderboard-username">${entry.displayName} <span class="lb-level-badge">Lv.${level}</span> <span class="lb-title">${title}</span></div>
                                <div class="leaderboard-user-stats">
                                    <span class="lb-stat lb-correct" title="æ­£è§£"><svg viewBox="0 0 24 24"><path d="M9 12l2 2 4-4"></path><circle cx="12" cy="12" r="9"></circle></svg>${entry.correct || 0}</span>
                                    <span class="lb-stat lb-wrong" title="éŒ¯é¡Œ"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"></circle><path d="M9 9l6 6M15 9l-6 6"></path></svg>${entry.wrong || 0}</span>
                                    <span class="lb-stat lb-combo" title="é€£æ’ƒ"><svg viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9z"></path></svg>${entry.combo || 0}</span>
                                    <span class="lb-stat lb-total" title="ç·é¡Œ"><svg viewBox="0 0 24 24"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>${entry.total || 0}</span>
                                </div>
                                ${lastBestText ? `<div class="lb-lastbest">æœ€çµ‚æ›´æ–°: ${lastBestText}</div>` : ''}
                            </div>
                        </div>
                        <div class="leaderboard-score">${entry.score}</div>
                    </div>
                `;
            });

            leaderboardList.innerHTML = html;

            // æ›´æ–°åˆ†é¡µ
            updateLeaderboardPagination();
        }

        // Update leaderboard pagination
        function updateLeaderboardPagination() {
            const totalPages = Math.ceil(leaderboardData.length / leaderboardPageSize);
            const pagination = document.getElementById('leaderboard-pagination');
            const prevBtn = document.getElementById('prev-leaderboard-page');
            const nextBtn = document.getElementById('next-leaderboard-page');
            const currentPageEl = document.getElementById('current-leaderboard-page');
            const totalPagesEl = document.getElementById('total-leaderboard-pages');

            if (totalPages <= 1) {
                if (pagination) pagination.style.display = 'none';
                return;
            }

            if (pagination) pagination.style.display = 'flex';
            if (prevBtn) prevBtn.disabled = currentLeaderboardPage <= 1;
            if (nextBtn) nextBtn.disabled = currentLeaderboardPage >= totalPages;
            if (currentPageEl) currentPageEl.textContent = currentLeaderboardPage;
            if (totalPagesEl) totalPagesEl.textContent = totalPages;
        }

        // Make functions available globally
        window.syncUserData = syncUserData;
        window.loadUserData = loadUserData;
        window.submitScoreToLeaderboard = submitScoreToLeaderboard;
        window.loadLeaderboard = loadLeaderboard;
        
        // Auto-sync on data changes
        let autoSyncTimer = null;
        window.autoSyncData = function() {
            if (!window.firebaseAuth || !window.syncUserData) return;
            
            const user = window.firebaseAuth.currentUser;
            if (!user) return;
            
            if (autoSyncTimer) clearTimeout(autoSyncTimer);
            
            autoSyncTimer = setTimeout(async () => {
                try {
                    console.log('ğŸ”„ è‡ªåŠ¨åŒæ­¥...');
                    await window.syncUserData(user);
                } catch (error) {
                    console.error('âŒ è‡ªåŠ¨åŒæ­¥å¤±è´¥:', error);
                }
            }, 1000);
        };
        
        // Sync before page unload
        window.addEventListener('beforeunload', async () => {
            const user = auth.currentUser;
            if (user) {
                try {
                    await syncUserData(user);
                } catch (error) {
                    console.error('Error syncing on page unload:', error);
                }
            }
        });
        
        // Simple notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                background: ${type === 'success' ? '#16a34a' : type === 'error' ? '#dc2626' : '#4f46e5'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-size: 14px;
                max-width: 320px;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
    </script>

    <!-- PWA Installation Script -->
    <script>
        let deferredPrompt;
        const installPWAGuest = document.getElementById('installPWAGuest');
        const installPWAUser = document.getElementById('installPWAUser');
        const pwaModal = document.getElementById('pwa-install-modal');
        const pwaBackdrop = document.getElementById('modal-backdrop');
        const pwaAddToHomeBtn = document.getElementById('pwa-add-to-home');

        // Listen for beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install buttons
            if (installPWAGuest) installPWAGuest.style.display = 'flex';
            if (installPWAUser) installPWAUser.style.display = 'flex';
            
            console.log('[PWA] Install prompt captured');
        });

        // Handle PWA installation
        async function installPWA() {
            if (!deferredPrompt) {
                // iOS or already installed
                showIOSInstallInstructions();
                return;
            }

            try {
                // Show modal
                if (pwaModal) pwaModal.classList.remove('hidden');
                if (pwaBackdrop) pwaBackdrop.classList.remove('hidden');
                
                // Close menus
                document.getElementById('guestMenu')?.classList.remove('show');
                document.getElementById('userMenu')?.classList.remove('show');

                // Step 1: Clear cache
                await showStep('pwa-step-1');
                await clearAllCaches();
                
                // Step 2: Download resources
                await showStep('pwa-step-2');
                await downloadResources();
                
                // Step 3: Show install prompt
                await showStep('pwa-step-3');
                
            } catch (error) {
                console.error('[PWA] Installation error:', error);
                showError(error.message);
            }
        }

        async function clearAllCaches() {
            const progressBar = document.getElementById('pwa-progress-1');
            const progressText = document.getElementById('pwa-progress-text-1');
            
            try {
                progressText.textContent = 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ä¸­...';
                progressBar.style.width = '30%';
                
                // Clear all caches
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
                
                progressBar.style.width = '100%';
                progressText.textContent = 'å®Œäº†';
                
                await new Promise(resolve => setTimeout(resolve, 500));
            } catch (error) {
                console.error('[PWA] Cache clear error:', error);
            }
        }

        async function downloadResources() {
            const progressBar = document.getElementById('pwa-progress-2');
            const progressText = document.getElementById('pwa-progress-text-2');
            
            const resources = [
                '/',
                '/index.html',
                '/static/app.js',
                '/static/styles.css',
                '/static/config.json',
                '/manifest.json'
            ];
            
            let completed = 0;
            progressText.textContent = `${completed} / ${resources.length} ãƒ•ã‚¡ã‚¤ãƒ«`;
            
            for (const url of resources) {
                try {
                    await fetch(url, { cache: 'reload' });
                    completed++;
                    const percent = (completed / resources.length) * 100;
                    progressBar.style.width = `${percent}%`;
                    progressText.textContent = `${completed} / ${resources.length} ãƒ•ã‚¡ã‚¤ãƒ«`;
                    await new Promise(resolve => setTimeout(resolve, 100));
                } catch (error) {
                    console.error(`[PWA] Failed to download ${url}:`, error);
                }
            }
        }

        function showStep(stepId) {
            return new Promise(resolve => {
                document.querySelectorAll('.pwa-step').forEach(step => {
                    step.classList.add('hidden');
                });
                const step = document.getElementById(stepId);
                if (step) {
                    step.classList.remove('hidden');
                }
                setTimeout(resolve, 300);
            });
        }

        function showError(message) {
            showStep('pwa-step-error');
            const errorMsg = document.getElementById('pwa-error-message');
            if (errorMsg) errorMsg.textContent = message;
        }

        function showIOSInstallInstructions() {
            // Show iOS install instructions
            if (pwaModal) pwaModal.classList.remove('hidden');
            if (pwaBackdrop) pwaBackdrop.classList.remove('hidden');
            
            document.querySelectorAll('.pwa-step').forEach(step => step.classList.add('hidden'));
            
            const iosStep = document.createElement('div');
            iosStep.className = 'pwa-step';
            iosStep.innerHTML = `
                <div class="pwa-icon">ğŸ“±</div>
                <h3>ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </h3>
                <p style="text-align: left; margin: 16px 0;">
                    <strong>iOS ã®å ´åˆ:</strong><br>
                    1. å…±æœ‰ãƒœã‚¿ãƒ³ <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle;"><path d="M16 5l-1.42 1.42-1.59-1.59V16h-1.98V4.83L9.42 6.42 8 5l4-4 4 4zm4 5v11c0 1.1-.9 2-2 2H6c-1.11 0-2-.9-2-2V10c0-1.11.89-2 2-2h3v2H6v11h12V10h-3V8h3c1.1 0 2 .89 2 2z"/></svg> ã‚’ã‚¿ãƒƒãƒ—<br>
                    2. ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’é¸æŠ<br>
                    3. ã€Œè¿½åŠ ã€ã‚’ã‚¿ãƒƒãƒ—
                </p>
                <button type="button" class="ghost-button" data-close="pwa-modal" style="margin-top: 16px;">é–‰ã˜ã‚‹</button>
            `;
            
            const content = document.getElementById('pwa-install-content');
            if (content) {
                content.appendChild(iosStep);
            }
        }

        // Add to home screen button
        if (pwaAddToHomeBtn) {
            pwaAddToHomeBtn.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                console.log(`[PWA] User response: ${outcome}`);
                
                if (outcome === 'accepted') {
                    console.log('[PWA] PWA installed');
                }
                
                deferredPrompt = null;
                if (installPWAGuest) installPWAGuest.style.display = 'none';
                if (installPWAUser) installPWAUser.style.display = 'none';
                
                // Close modal
                if (pwaModal) pwaModal.classList.add('hidden');
                if (pwaBackdrop) pwaBackdrop.classList.add('hidden');
            });
        }

        // Install button click handlers
        if (installPWAGuest) {
            installPWAGuest.addEventListener('click', installPWA);
        }
        if (installPWAUser) {
            installPWAUser.addEventListener('click', installPWA);
        }

        // Close PWA modal
        document.querySelectorAll('[data-close="pwa-modal"]').forEach(btn => {
            btn.addEventListener('click', () => {
                if (pwaModal) pwaModal.classList.add('hidden');
                if (pwaBackdrop) pwaBackdrop.classList.add('hidden');
            });
        });

        // Register Service Worker
        let swRegistration = null;
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        swRegistration = registration;
                        console.log('[PWA] Service Worker registered:', registration.scope);
                        
                        // æ£€æŸ¥ç¼“å­˜çŠ¶æ€
                        checkOfflineStatus();
                        
                        // æ£€æŸ¥æ›´æ–°
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('[PWA] æ–°ç‰ˆæœ¬å¯ç”¨');
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('[PWA] Service Worker registration failed:', error);
                    });
            });
        }
        
        // æ£€æŸ¥ç¦»çº¿ç¼“å­˜çŠ¶æ€
        async function checkOfflineStatus() {
            if (!navigator.serviceWorker || !navigator.serviceWorker.controller) {
                return;
            }
            
            const statusDiv = document.getElementById('offline-status');
            if (!statusDiv) return;
            
            // è®¾ç½®æ¶ˆæ¯ç›‘å¬å™¨
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data.type === 'CACHE_STATUS') {
                    const { cached, total, percentage } = event.data;
                    if (percentage === 100) {
                        statusDiv.innerHTML = `âœ… ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ (${cached}/${total})`;
                        statusDiv.style.color = '#16a34a';
                    } else if (cached > 0) {
                        statusDiv.innerHTML = `âš ï¸ ä¸€éƒ¨ã®ãƒªã‚½ãƒ¼ã‚¹ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ (${cached}/${total} - ${percentage}%)`;
                        statusDiv.style.color = '#f59e0b';
                    } else {
                        statusDiv.innerHTML = `ğŸ“¥ ã¾ã ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“`;
                        statusDiv.style.color = '#64748b';
                    }
                }
            });
            
            // è¯·æ±‚ç¼“å­˜çŠ¶æ€
            navigator.serviceWorker.controller.postMessage({
                type: 'CHECK_CACHE'
            });
        }
        
        // ä¸‹è½½ç¦»çº¿èµ„æº
        async function downloadForOffline() {
            const downloadBtn = document.getElementById('download-for-offline');
            const statusDiv = document.getElementById('offline-status');
            
            if (!navigator.serviceWorker || !navigator.serviceWorker.controller) {
                statusDiv.innerHTML = 'âŒ Service Worker ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“';
                statusDiv.style.color = '#dc2626';
                return;
            }
            
            // ç¦ç”¨æŒ‰é’®
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px; animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path></svg>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...';
            
            // è®¾ç½®è¿›åº¦ç›‘å¬å™¨
            const messageHandler = (event) => {
                if (event.data.type === 'DOWNLOAD_PROGRESS') {
                    const { completed, total, percentage, failed, status } = event.data;
                    
                    if (status === 'started') {
                        statusDiv.innerHTML = 'ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹...';
                        statusDiv.style.color = '#4f46e5';
                    } else if (status === 'downloading') {
                        statusDiv.innerHTML = `ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­... ${completed}/${total} (${percentage}%)`;
                        if (failed > 0) {
                            statusDiv.innerHTML += ` - ${failed}ä»¶å¤±æ•—`;
                        }
                        statusDiv.style.color = '#4f46e5';
                    } else if (status === 'completed') {
                        navigator.serviceWorker.removeEventListener('message', messageHandler);
                        
                        if (failed === 0) {
                            statusDiv.innerHTML = `âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼ (${completed}/${total})`;
                            statusDiv.style.color = '#16a34a';
                            
                            // æ˜¾ç¤ºiOSæ·»åŠ åˆ°ä¸»å±çš„æç¤º
                            showAddToHomeScreenPrompt();
                        } else {
                            statusDiv.innerHTML = `âš ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº† (${completed}/${total} - ${failed}ä»¶å¤±æ•—)`;
                            statusDiv.style.color = '#f59e0b';
                        }
                        
                        downloadBtn.disabled = false;
                        downloadBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
                    }
                }
            };
            
            navigator.serviceWorker.addEventListener('message', messageHandler);
            
            // å‘é€ä¸‹è½½è¯·æ±‚
            navigator.serviceWorker.controller.postMessage({
                type: 'DOWNLOAD_ALL'
            });
        }
        
        // æ˜¾ç¤ºæ·»åŠ åˆ°ä¸»å±çš„æç¤º
        function showAddToHomeScreenPrompt() {
            // æ£€æµ‹æ˜¯å¦æ˜¯iOS
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isInStandaloneMode = ('standalone' in window.navigator) && (window.navigator.standalone);
            
            if (isIOS && !isInStandaloneMode) {
                // æ˜¾ç¤ºiOSæ·»åŠ æç¤º
                const statusDiv = document.getElementById('offline-status');
                statusDiv.innerHTML = `
                    <div style="margin-top: 16px; padding: 12px; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; text-align: left;">
                        <strong style="color: #0369a1;">ğŸ“± ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ :</strong><br>
                        <span style="font-size: 12px; color: #0c4a6e;">
                            1. å…±æœ‰ãƒœã‚¿ãƒ³ <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle;"><path d="M16 5l-1.42 1.42-1.59-1.59V16h-1.98V4.83L9.42 6.42 8 5l4-4 4 4zm4 5v11c0 1.1-.9 2-2 2H6c-1.11 0-2-.9-2-2V10c0-1.11.89-2 2-2h3v2H6v11h12V10h-3V8h3c1.1 0 2 .89 2 2z"/></svg> ã‚’ã‚¿ãƒƒãƒ—<br>
                            2. ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’é¸æŠ<br>
                            3. ã€Œè¿½åŠ ã€ã‚’ã‚¿ãƒƒãƒ—
                        </span>
                    </div>
                `;
            } else if (!isIOS && deferredPrompt) {
                // å¯¹äºAndroidç­‰å¹³å°ï¼Œæ˜¾ç¤ºå®‰è£…æç¤º
                const statusDiv = document.getElementById('offline-status');
                statusDiv.innerHTML = `
                    <div style="margin-top: 16px;">
                        <button onclick="installPWA()" style="width: 100%; padding: 10px; background: #4f46e5; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            ğŸ“± ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
                        </button>
                    </div>
                `;
            }
        }
        
        // æ·»åŠ ä¸‹è½½æŒ‰é’®çš„äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', () => {
            const downloadBtn = document.getElementById('download-for-offline');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', downloadForOffline);
            }
            
            // ç¦»çº¿ä¸‹è½½æ¨¡æ€æ¡†æ§åˆ¶
            const offlineModal = document.getElementById('offline-download-modal');
            const backdrop = document.getElementById('modal-backdrop');
            const downloadOfflineGuest = document.getElementById('downloadOfflineGuest');
            const downloadOfflineUser = document.getElementById('downloadOfflineUser');
            const guestMenu = document.getElementById('guestMenu');
            const userMenu = document.getElementById('userMenu');
            
            // æ‰“å¼€ç¦»çº¿ä¸‹è½½æ¨¡æ€æ¡†
            function openOfflineModal() {
                if (offlineModal) offlineModal.classList.remove('hidden');
                if (backdrop) backdrop.classList.remove('hidden');
                setTimeout(checkOfflineStatus, 100);
                if (guestMenu) guestMenu.classList.remove('show');
                if (userMenu) userMenu.classList.remove('show');
            }
            
            if (downloadOfflineGuest) {
                downloadOfflineGuest.addEventListener('click', openOfflineModal);
            }
            
            if (downloadOfflineUser) {
                downloadOfflineUser.addEventListener('click', openOfflineModal);
            }
            
            // å…³é—­ç¦»çº¿ä¸‹è½½æ¨¡æ€æ¡†
            document.querySelectorAll('[data-close="offline-modal"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (offlineModal) offlineModal.classList.add('hidden');
                    if (backdrop) backdrop.classList.add('hidden');
                });
            });
        });

        // Listen for app installed event
        window.addEventListener('appinstalled', () => {
            console.log('[PWA] App installed');
            deferredPrompt = null;
            if (installPWAGuest) installPWAGuest.style.display = 'none';
            if (installPWAUser) installPWAUser.style.display = 'none';
        });
    </script>
    
    <script>
        // ç®€å•çš„è™šæ‹Ÿé”®ç›˜åˆ‡æ¢å‡½æ•°
        function toggleVirtualKeyboard() {
            console.log('toggleVirtualKeyboard è¢«è°ƒç”¨');
            const keyboard = document.getElementById('virtual-keyboard');
            const answerInput = document.getElementById('answer-input');
            if (keyboard) {
                console.log('æ‰¾åˆ°é”®ç›˜å…ƒç´ ');
                
                // æ£€æŸ¥å½“å‰çŠ¶æ€å¹¶åˆ‡æ¢
                if (keyboard.classList.contains('show')) {
                    // å½“å‰æ˜¾ç¤ºï¼Œåˆ‡æ¢ä¸ºéšè—
                    keyboard.classList.remove('show');
                    keyboard.classList.add('hidden');
                    console.log('é”®ç›˜éšè—');
                    
                    // æ¢å¤inputçš„æ­£å¸¸çŠ¶æ€
                    if (answerInput) {
                        answerInput.readOnly = false;
                    }
                } else {
                    // å½“å‰éšè—ï¼Œåˆ‡æ¢ä¸ºæ˜¾ç¤º
                    keyboard.classList.remove('hidden');
                    keyboard.classList.add('show');
                    console.log('é”®ç›˜æ˜¾ç¤º');
                    
                    // å½“è™šæ‹Ÿé”®ç›˜æ˜¾ç¤ºæ—¶ï¼Œè®¾ç½®inputä¸ºreadonlyä»¥é˜²æ­¢æ‰‹æœºè¾“å…¥æ³•å¼¹å‡º
                    if (answerInput) {
                        answerInput.readOnly = true;
                        answerInput.blur(); // ç§»é™¤ç„¦ç‚¹ï¼Œé˜²æ­¢æ‰‹æœºè¾“å…¥æ³•å¼¹å‡º
                    }
                }
                
                console.log('é”®ç›˜çŠ¶æ€:', keyboard.classList.toString());
            } else {
                console.error('æœªæ‰¾åˆ°é”®ç›˜å…ƒç´ ');
            }
        }
        
        // å…³é—­é”®ç›˜å‡½æ•°
        function closeVirtualKeyboard() {
            const keyboard = document.getElementById('virtual-keyboard');
            const answerInput = document.getElementById('answer-input');
            if (keyboard) {
                keyboard.classList.remove('show');
                keyboard.classList.add('hidden');
                
                // æ¢å¤inputçš„æ­£å¸¸çŠ¶æ€
                if (answerInput) {
                    answerInput.readOnly = false;
                }
            }
        }
        
        // å¤„ç†é”®ç›˜æŒ‰é”®ç‚¹å‡»
        function handleKeyboardKey(key) {
            console.log('é”®ç›˜æŒ‰é”®è¢«ç‚¹å‡»:', key);
            
            // æ’­æ”¾æŒ‰é”®éŸ³æ•ˆ
            playKeySound();
            
            const input = document.getElementById('answer-input');
            if (!input) return;
            
            const currentValue = input.value;
            const cursorPos = input.selectionStart;
            
            switch (key) {
                case 'backspace':
                    console.log('åˆ é™¤é”®è¢«ç‚¹å‡» - å½“å‰å€¼:', currentValue, 'é•¿åº¦:', currentValue.length, 'å…‰æ ‡ä½ç½®:', cursorPos);
                    
                    // å¤šé‡å¤‡ç”¨æœºåˆ¶ç¡®ä¿åˆ é™¤é”®æ°¸è¿œä¸ä¼šå¤±æ•ˆ
                    try {
                        // å¼ºåˆ¶è®©inputè·å¾—ç„¦ç‚¹
                        input.focus();
                        
                        // ä¸´æ—¶ç§»é™¤readonlyä»¥å…è®¸ä¿®æ”¹
                        const wasReadonly = input.readOnly;
                        input.readOnly = false;
                        
                        // é‡æ–°è·å–å½“å‰å€¼ï¼Œé˜²æ­¢å€¼ä¸åŒæ­¥
                        const freshValue = input.value || '';
                        console.log('é‡æ–°è·å–çš„å½“å‰å€¼:', freshValue);
                        
                        if (freshValue.length > 0) {
                            // å¦‚æœå…‰æ ‡ä½ç½®æ— æ•ˆæˆ–ä¸º0ï¼Œåˆ™åˆ é™¤æœ€åä¸€ä¸ªå­—ç¬¦
                            let actualCursorPos = cursorPos;
                            if (actualCursorPos <= 0 || actualCursorPos > freshValue.length) {
                                actualCursorPos = freshValue.length;
                            }
                            
                            // è®¡ç®—åˆ é™¤åçš„æ–°å€¼
                            const newValue = freshValue.slice(0, actualCursorPos - 1) + freshValue.slice(actualCursorPos);
                            console.log('åˆ é™¤åæ–°å€¼:', newValue, 'åˆ é™¤ä½ç½®:', actualCursorPos - 1);
                            
                            // ç›´æ¥è®¾ç½®æ–°å€¼
                            input.value = newValue;
                            
                            // è®¾ç½®å…‰æ ‡ä½ç½®åˆ°åˆ é™¤åçš„ä½ç½®
                            const newCursorPos = Math.max(0, actualCursorPos - 1);
                            input.setSelectionRange(newCursorPos, newCursorPos);
                            
                            // è§¦å‘inputäº‹ä»¶ï¼Œç¡®ä¿WanaKanaç­‰åº“èƒ½æ£€æµ‹åˆ°å˜åŒ–
                            input.dispatchEvent(new Event('input', { bubbles: true }));
                            input.dispatchEvent(new Event('change', { bubbles: true }));
                            
                            console.log('åˆ é™¤æˆåŠŸ - æ–°å€¼:', input.value, 'æ–°å…‰æ ‡ä½ç½®:', newCursorPos);
                        } else {
                            console.log('è¾“å…¥æ¡†ä¸ºç©ºï¼Œæ— éœ€åˆ é™¤');
                        }
                        
                        // æ¢å¤readonlyçŠ¶æ€
                        input.readOnly = wasReadonly;
                        
                    } catch (error) {
                        console.error('åˆ é™¤é”®å¤„ç†å‡ºé”™:', error);
                        
                        // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥åˆ é™¤æœ€åä¸€ä¸ªå­—ç¬¦
                        try {
                            const currentVal = input.value || '';
                            if (currentVal.length > 0) {
                                input.value = currentVal.slice(0, -1);
                                input.dispatchEvent(new Event('input', { bubbles: true }));
                                console.log('å¤‡ç”¨åˆ é™¤æ–¹æ¡ˆæ‰§è¡ŒæˆåŠŸ');
                            }
                        } catch (backupError) {
                            console.error('å¤‡ç”¨åˆ é™¤æ–¹æ¡ˆä¹Ÿå¤±è´¥:', backupError);
                        }
                    }
                    break;
                case 'clear':
                    // ä¸´æ—¶ç§»é™¤readonlyä»¥å…è®¸ä¿®æ”¹
                    const wasReadonlyClear = input.readOnly;
                    input.readOnly = false;
                    input.value = '';
                    input.readOnly = wasReadonlyClear;
                    break;
                case 'space':
                    // å¼ºåˆ¶è®©inputè·å¾—ç„¦ç‚¹
                    input.focus();
                    
                    // ä¸´æ—¶ç§»é™¤readonlyä»¥å…è®¸ä¿®æ”¹
                    const wasReadonlySpace = input.readOnly;
                    input.readOnly = false;
                    
                    // ç¡®ä¿å…‰æ ‡ä½ç½®æœ‰æ•ˆ
                    let actualCursorPosSpace = cursorPos;
                    if (actualCursorPosSpace < 0 || actualCursorPosSpace > currentValue.length) {
                        actualCursorPosSpace = currentValue.length;
                    }
                    
                    const newValue = currentValue.slice(0, actualCursorPosSpace) + ' ' + currentValue.slice(actualCursorPosSpace);
                    input.value = newValue;
                    input.setSelectionRange(actualCursorPosSpace + 1, actualCursorPosSpace + 1);
                    input.readOnly = wasReadonlySpace;
                    break;
                case 'enter':
                    // å›è½¦é”® - æäº¤ç­”æ¡ˆ
                    console.log('å›è½¦é”®è¢«ç‚¹å‡»');
                    const submitBtn = document.getElementById('answer-submit');
                    if (submitBtn && !submitBtn.disabled) {
                        console.log('è§¦å‘æäº¤æŒ‰é’®ç‚¹å‡»');
                        submitBtn.click();
                    } else {
                        console.log('æäº¤æŒ‰é’®æœªæ‰¾åˆ°æˆ–å·²ç¦ç”¨');
                    }
                    break;
                case 'skip':
                    // ã‚¹ã‚­ãƒƒãƒ—æŒ‰é’® - è§¦å‘è·³è¿‡åŠŸèƒ½
                    const skipBtn = document.getElementById('skip-button');
                    if (skipBtn && !skipBtn.disabled) {
                        skipBtn.click();
                    }
                    break;
                case 'kana-toggle':
                    // å¹³å‡å/ç‰‡å‡ååˆ‡æ¢é”®
                    katakanaMode = !katakanaMode;
                    updateKanaToggleButton();
                    break;
                case 'l':
                    // lé”® - è¾“å…¥é•¿éŸ³ç¬¦å·ï¼ˆãƒ¼ï¼‰
                    input.focus();
                    
                    // ä¸´æ—¶ç§»é™¤readonlyä»¥å…è®¸ä¿®æ”¹
                    const wasReadonlyL = input.readOnly;
                    input.readOnly = false;
                    
                    // ç¡®ä¿å…‰æ ‡ä½ç½®æœ‰æ•ˆ
                    let actualCursorPosL = cursorPos;
                    if (actualCursorPosL < 0 || actualCursorPosL > currentValue.length) {
                        actualCursorPosL = currentValue.length;
                    }
                    
                    // æ’å…¥é•¿éŸ³ç¬¦å·
                    const longVowel = 'ãƒ¼';
                    const newValueWithLongVowel = currentValue.slice(0, actualCursorPosL) + longVowel + currentValue.slice(actualCursorPosL);
                    console.log('æ’å…¥é•¿éŸ³ç¬¦å· - æ–°å€¼:', newValueWithLongVowel, 'æ’å…¥ä½ç½®:', actualCursorPosL);
                    input.value = newValueWithLongVowel;
                    input.setSelectionRange(actualCursorPosL + 1, actualCursorPosL + 1);
                    input.readOnly = wasReadonlyL;
                    break;
                default:
                    // å­—æ¯å­—ç¬¦ - ç›´æ¥æ’å…¥åˆ°å…‰æ ‡ä½ç½®
                    // å¼ºåˆ¶è®©inputè·å¾—ç„¦ç‚¹
                    input.focus();
                    
                    // ä¸´æ—¶ç§»é™¤readonlyä»¥å…è®¸ä¿®æ”¹
                    const wasReadonlyChar = input.readOnly;
                    input.readOnly = false;
                    
                    // ç¡®ä¿å…‰æ ‡ä½ç½®æœ‰æ•ˆ
                    let actualCursorPosChar = cursorPos;
                    if (actualCursorPosChar < 0 || actualCursorPosChar > currentValue.length) {
                        actualCursorPosChar = currentValue.length;
                    }
                    
                    // å¤„ç†ç‰‡å‡å/å¹³å‡åæ¨¡å¼
                    let charToInsert = katakanaMode ? key.toUpperCase() : key.toLowerCase();
                    
                    const newValueWithChar = currentValue.slice(0, actualCursorPosChar) + charToInsert + currentValue.slice(actualCursorPosChar);
                    console.log('æ’å…¥å­—ç¬¦å - æ–°å€¼:', newValueWithChar, 'æ’å…¥ä½ç½®:', actualCursorPosChar);
                    input.value = newValueWithChar;
                    input.setSelectionRange(actualCursorPosChar + 1, actualCursorPosChar + 1);
                    input.readOnly = wasReadonlyChar;
                    break;
            }
            
            // ç»Ÿä¸€è§¦å‘ä¸€æ¬¡inputäº‹ä»¶è®©WanaKanaå¤„ç†
            input.dispatchEvent(new Event('input', { bubbles: true }));
            
            // ç­‰å¾…WanaKanaå¤„ç†åå†æ£€æŸ¥ç»“æœ
            setTimeout(() => {
                console.log('WanaKanaå¤„ç†åï¼Œå½“å‰å€¼:', input.value);
            }, 100);
            
            input.focus();
        }
        
        // è™šæ‹Ÿé”®ç›˜çŠ¶æ€ç®¡ç†
        let katakanaMode = false; // ç‰‡å‡åæ¨¡å¼
        
        // æŒ‰é”®éŸ³æ•ˆ
        function playKeySound() {
            try {
                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // åˆ›å»ºæŒ¯è¡å™¨
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                // è¿æ¥èŠ‚ç‚¹
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // è®¾ç½®éŸ³æ•ˆå‚æ•°
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime); // 800Hz
                oscillator.type = 'sine';
                
                // è®¾ç½®éŸ³é‡åŒ…ç»œ
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                // æ’­æ”¾éŸ³æ•ˆ
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
                
            } catch (error) {
                console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°å¹³å‡å/ç‰‡å‡ååˆ‡æ¢é”®æ ·å¼
        function updateKanaToggleButton() {
            const kanaButton = document.querySelector('.key-kana-toggle');
            const kanaIndicator = document.querySelector('.kana-indicator');
            if (kanaButton && kanaIndicator) {
                kanaButton.classList.toggle('katakana-mode', katakanaMode);
                kanaIndicator.textContent = katakanaMode ? 'ã‚«ã‚¿' : 'ã²ã‚‰';
            }
            
            // æ›´æ–°è™šæ‹Ÿé”®ç›˜ä¸Šçš„å­—æ¯æ˜¾ç¤º
            updateKeyboardLetterDisplay();
        }
        
        // æ›´æ–°è™šæ‹Ÿé”®ç›˜å­—æ¯æ˜¾ç¤º
        function updateKeyboardLetterDisplay() {
            const letterKeys = document.querySelectorAll('.key[data-key]');
            letterKeys.forEach(key => {
                const keyValue = key.getAttribute('data-key');
                // åªå¤„ç†å­—æ¯é”®ï¼ˆa-zï¼‰
                if (keyValue && keyValue.length === 1 && keyValue >= 'a' && keyValue <= 'z') {
                    if (katakanaMode) {
                        // ç‰‡å‡åæ¨¡å¼ï¼šæ˜¾ç¤ºå¤§å†™å­—æ¯
                        key.textContent = keyValue.toUpperCase();
                    } else {
                        // å¹³å‡åæ¨¡å¼ï¼šæ˜¾ç¤ºå°å†™å­—æ¯
                        key.textContent = keyValue.toLowerCase();
                    }
                }
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ·»åŠ é”®ç›˜æŒ‰é”®äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            // è™šæ‹Ÿé”®ç›˜é»˜è®¤å¼€å¯ï¼Œè®¾ç½®inputä¸ºreadonlyå¹¶é˜»æ­¢ç„¦ç‚¹
            const answerInput = document.getElementById('answer-input');
            if (answerInput) {
                answerInput.readOnly = true;
                answerInput.blur();
                
                // æ·»åŠ å…¨é¢çš„ç„¦ç‚¹é˜»æ­¢äº‹ä»¶ç›‘å¬å™¨
                function forcePreventFocus(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    console.log('å¼ºåˆ¶é˜»æ­¢inputè·å–ç„¦ç‚¹:', e.type);
                    // ç«‹å³ç§»é™¤ç„¦ç‚¹
                    if (e.target && e.target.blur) {
                        e.target.blur();
                    }
                    return false;
                }
                
                answerInput.addEventListener('focus', forcePreventFocus, { passive: false, capture: true });
                answerInput.addEventListener('click', forcePreventFocus, { passive: false, capture: true });
                answerInput.addEventListener('touchstart', forcePreventFocus, { passive: false, capture: true });
                answerInput.addEventListener('touchend', forcePreventFocus, { passive: false, capture: true });
                answerInput.addEventListener('mousedown', forcePreventFocus, { passive: false, capture: true });
                answerInput.addEventListener('mouseup', forcePreventFocus, { passive: false, capture: true });
                answerInput.addEventListener('pointerdown', forcePreventFocus, { passive: false, capture: true });
                answerInput.addEventListener('pointerup', forcePreventFocus, { passive: false, capture: true });
            }
            
            // åˆå§‹åŒ–è™šæ‹Ÿé”®ç›˜å­—æ¯æ˜¾ç¤º
            updateKeyboardLetterDisplay();
            const keyboard = document.getElementById('virtual-keyboard');
            if (keyboard) {
                keyboard.addEventListener('click', function(e) {
                    if (e.target.classList.contains('key')) {
                        const key = e.target.getAttribute('data-key');
                        // æ’é™¤æœ‰ä¸“é—¨äº‹ä»¶å¤„ç†çš„é”®
                        if (key !== 'kana-toggle' && key !== 'enter') {
                            handleKeyboardKey(key);
                        }
                    }
                });
                
                
                // é˜²æ­¢ç§»åŠ¨ç«¯è¯¯è§¦æ”¾å¤§
                keyboard.addEventListener('touchstart', function(e) {
                    if (e.touches.length > 1) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                // ä¸ºåˆ é™¤é”®æ·»åŠ é¢å¤–çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼Œç¡®ä¿æ°¸è¿œä¸ä¼šå¤±æ•ˆ
                const backspaceButton = document.querySelector('.key-backspace');
                if (backspaceButton) {
                    // æ·»åŠ å¤šé‡äº‹ä»¶ç›‘å¬å™¨
                    const handleBackspaceClick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const input = document.getElementById('answer-input');
                        if (!input) return;
                        
                        console.log('åˆ é™¤é”®é¢å¤–ç›‘å¬å™¨è¢«è§¦å‘');
                        
                        // æ’­æ”¾æŒ‰é”®éŸ³æ•ˆ
                        playKeySound();
                        
                        try {
                            // å¼ºåˆ¶ç„¦ç‚¹
                            input.focus();
                            
                            // ä¸´æ—¶ç§»é™¤readonly
                            const wasReadonly = input.readOnly;
                            input.readOnly = false;
                            
                            // è·å–å½“å‰å€¼
                            const currentVal = input.value || '';
                            console.log('åˆ é™¤é”®é¢å¤–ç›‘å¬å™¨ - å½“å‰å€¼:', currentVal);
                            
                            if (currentVal.length > 0) {
                                // åˆ é™¤æœ€åä¸€ä¸ªå­—ç¬¦
                                const newVal = currentVal.slice(0, -1);
                                input.value = newVal;
                                
                                // è®¾ç½®å…‰æ ‡ä½ç½®
                                input.setSelectionRange(newVal.length, newVal.length);
                                
                                // è§¦å‘äº‹ä»¶
                                input.dispatchEvent(new Event('input', { bubbles: true }));
                                input.dispatchEvent(new Event('change', { bubbles: true }));
                                
                                console.log('åˆ é™¤é”®é¢å¤–ç›‘å¬å™¨ - åˆ é™¤æˆåŠŸï¼Œæ–°å€¼:', newVal);
                            }
                            
                            // æ¢å¤readonly
                            input.readOnly = wasReadonly;
                            
                        } catch (error) {
                            console.error('åˆ é™¤é”®é¢å¤–ç›‘å¬å™¨å‡ºé”™:', error);
                        }
                    };
                    
                    // æ·»åŠ å¤šç§äº‹ä»¶ç›‘å¬å™¨
                    backspaceButton.addEventListener('click', handleBackspaceClick, { passive: false });
                    backspaceButton.addEventListener('touchstart', handleBackspaceClick, { passive: false });
                    backspaceButton.addEventListener('mousedown', handleBackspaceClick, { passive: false });
                    
                    console.log('åˆ é™¤é”®é¢å¤–ç›‘å¬å™¨å·²æ·»åŠ ');
                }
                
                // ä¸ºå¹³å‡å/ç‰‡å‡ååˆ‡æ¢é”®æ·»åŠ ä¸“é—¨çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œç¡®ä¿ä¸ä¼šè¢«å…¶ä»–äº‹ä»¶å¹²æ‰°
                const kanaToggleButton = document.querySelector('.key-kana-toggle');
                if (kanaToggleButton) {
                    const handleKanaToggleClick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        
                        console.log('å¹³å‡å/ç‰‡å‡ååˆ‡æ¢é”®è¢«ç‚¹å‡»ï¼Œå½“å‰æ¨¡å¼:', katakanaMode);
                        
                        // æ’­æ”¾æŒ‰é”®éŸ³æ•ˆ
                        playKeySound();
                        
                        // åˆ‡æ¢æ¨¡å¼
                        katakanaMode = !katakanaMode;
                        
                        // æ›´æ–°æŒ‰é’®æ ·å¼
                        updateKanaToggleButton();
                        
                        console.log('åˆ‡æ¢åæ¨¡å¼:', katakanaMode);
                    };
                    
                    // æ·»åŠ å¤šç§äº‹ä»¶ç›‘å¬å™¨ï¼Œç¡®ä¿å“åº”
                    kanaToggleButton.addEventListener('click', handleKanaToggleClick, { passive: false });
                    kanaToggleButton.addEventListener('touchstart', handleKanaToggleClick, { passive: false });
                    kanaToggleButton.addEventListener('mousedown', handleKanaToggleClick, { passive: false });
                    
                    console.log('å¹³å‡å/ç‰‡å‡ååˆ‡æ¢é”®ä¸“é—¨ç›‘å¬å™¨å·²æ·»åŠ ');
                }
                
                // ä¸ºå›è½¦é”®æ·»åŠ ä¸“é—¨çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œç¡®ä¿ä¸ä¼šè¢«å…¶ä»–äº‹ä»¶å¹²æ‰°
                const enterButton = document.querySelector('.key-enter');
                if (enterButton) {
                    const handleEnterClick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        
                        console.log('å›è½¦é”®ä¸“é—¨ç›‘å¬å™¨è¢«è§¦å‘');
                        
                        // æ’­æ”¾æŒ‰é”®éŸ³æ•ˆ
                        playKeySound();
                        
                        const submitBtn = document.getElementById('answer-submit');
                        if (submitBtn && !submitBtn.disabled) {
                            console.log('è§¦å‘æäº¤æŒ‰é’®ç‚¹å‡»');
                            submitBtn.click();
                        } else {
                            console.log('æäº¤æŒ‰é’®æœªæ‰¾åˆ°æˆ–å·²ç¦ç”¨');
                        }
                    };
                    
                    // æ·»åŠ å¤šç§äº‹ä»¶ç›‘å¬å™¨ï¼Œç¡®ä¿å“åº”
                    enterButton.addEventListener('click', handleEnterClick, { passive: false });
                    enterButton.addEventListener('touchstart', handleEnterClick, { passive: false });
                    enterButton.addEventListener('mousedown', handleEnterClick, { passive: false });
                    
                    console.log('å›è½¦é”®ä¸“é—¨ç›‘å¬å™¨å·²æ·»åŠ ');
                }
                
                keyboard.addEventListener('touchend', function(e) {
                    if (e.touches.length > 1) {
                        e.preventDefault();
                    }
                }, { passive: false });
            }
            
            // ä¸ºè™šæ‹Ÿé”®ç›˜ä¸­çš„ã‚¹ã‚­ãƒƒãƒ—æŒ‰é’®æ·»åŠ ç›´æ¥äº‹ä»¶ç›‘å¬å™¨
            const keyboardSkipButton = document.getElementById('keyboard-skip-button');
            if (keyboardSkipButton) {
                keyboardSkipButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('è™šæ‹Ÿé”®ç›˜ã‚¹ã‚­ãƒƒãƒ—æŒ‰é’®è¢«ç‚¹å‡»');
                    
                    // è§¦å‘ä¸»ç•Œé¢çš„è·³è¿‡åŠŸèƒ½
                    const mainSkipBtn = document.getElementById('skip-button');
                    if (mainSkipBtn && !mainSkipBtn.disabled) {
                        mainSkipBtn.click();
                    }
                });
            }
            
            // å…¨å±€é˜²æ­¢ç§»åŠ¨ç«¯è¯¯è§¦æ”¾å¤§
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            document.addEventListener('touchend', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
        });
    </script>
    
    <!-- è™šæ‹Ÿé”®ç›˜ -->
    <div id="virtual-keyboard" class="virtual-keyboard show">
        <div class="keyboard-body">
            <!-- QWERTY ç¬¬ä¸€è¡Œ -->
            <div class="keyboard-row">
                <button class="key" data-key="q">q</button>
                <button class="key" data-key="w">w</button>
                <button class="key" data-key="e">e</button>
                <button class="key" data-key="r">r</button>
                <button class="key" data-key="t">t</button>
                <button class="key" data-key="y">y</button>
                <button class="key" data-key="u">u</button>
                <button class="key" data-key="i">i</button>
                <button class="key" data-key="o">o</button>
                <button class="key" data-key="p">p</button>
            </div>
            <!-- QWERTY ç¬¬äºŒè¡Œ -->
            <div class="keyboard-row">
                <button class="key" data-key="a">a</button>
                <button class="key" data-key="s">s</button>
                <button class="key" data-key="d">d</button>
                <button class="key" data-key="f">f</button>
                <button class="key" data-key="g">g</button>
                <button class="key" data-key="h">h</button>
                <button class="key" data-key="j">j</button>
                <button class="key" data-key="k">k</button>
                <button class="key" data-key="l">l</button>
            </div>
            <!-- QWERTY ç¬¬ä¸‰è¡Œ -->
            <div class="keyboard-row">
                <button class="key key-kana-toggle" data-key="kana-toggle">
                    <span class="kana-indicator">ã²ã‚‰</span>
                </button>
                <button class="key" data-key="z">z</button>
                <button class="key" data-key="x">x</button>
                <button class="key" data-key="c">c</button>
                <button class="key" data-key="v">v</button>
                <button class="key" data-key="b">b</button>
                <button class="key" data-key="n">n</button>
                <button class="key" data-key="m">m</button>
                <button class="key key-backspace" data-key="backspace">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/>
                        <path d="M18 9l-6 6"/>
                        <path d="M12 9l6 6"/>
                    </svg>
                </button>
            </div>
            <!-- åŠŸèƒ½é”®è¡Œ -->
            <div class="keyboard-row keyboard-controls">
                <button type="button" id="keyboard-skip-button" class="keyboard-skip-button" title="ã“ã®å•é¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—">ã‚¹ã‚­ãƒƒãƒ—</button>
                <button class="key key-space" data-key="space">
                    <span class="space-text">Space</span>
                    <span class="space-lang">A</span>
                </button>
                <button class="key key-enter" data-key="enter">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 10l-5 5 5 5"/>
                        <path d="M20 4v7a4 4 0 0 1-4 4H4"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</body>
</html>
