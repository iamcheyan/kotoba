<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>言葉 | Kotoba Vocabulary Trainer</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?v=1">
    <link rel="apple-touch-icon" href="/static/icon-192.png">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="言葉">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#667eea">
    
    <link rel="stylesheet" href="/static/styles.css">
    <script>
        (function () {
            function prepareModuleEnv() {
                window.module = { exports: {} };
                window.exports = window.module.exports;
            }

            window.__captureModule = function (target) {
                if (!window.module || !window.module.exports) {
                    return;
                }
                const exported = window.module.exports;
                const ctor = exported && (exported.default || exported[target] || exported);
                if (ctor) {
                    window[target] = ctor;
                }
                prepareModuleEnv();
            };

            if (typeof window.require === 'undefined') {
                window.require = function (name) {
                    if (name === 'kuromoji') {
                        return window.kuromoji;
                    }
                    return null;
                };
            }

            prepareModuleEnv();
        })();
    </script>
    <script defer src="/static/vendor/kuromoji/kuromoji.js"></script>
    <script defer src="/static/vendor/kuroshiro/kuroshiro.min.js" onload="window.__captureModule('Kuroshiro')"></script>
    <script defer src="/static/vendor/kuroshiro-analyzer-kuromoji/kuroshiro-analyzer-kuromoji.min.js" onload="window.__captureModule('KuromojiAnalyzer')"></script>
    <script defer src="/static/vendor/wanakana/wanakana.min.js" onload="window.__captureModule('wanakana')"></script>
    <script>
        window.addEventListener('load', function () {
            delete window.module;
            delete window.exports;
            delete window.require;
            delete window.__captureModule;
        });
    </script>
    <script defer src="/static/app.js"></script>
</head>
<body>
    <div class="app">
        <header class="app-header">
            <div class="header-left">
                <div class="branding">
                    <span class="branding-logo" aria-hidden="true">
                        <svg width="42" height="42" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg" role="img">
                            <path fill="#A6D388" d="M6.401 28.55c5.006 5.006 16.502 11.969 29.533-.07c-7.366-1.417-8.662-10.789-13.669-15.794c-5.006-5.007-11.991-6.139-16.998-1.133c-5.006 5.006-3.873 11.99 1.134 16.997z"></path>
                            <path fill="#77B255" d="M24.684 29.81c6.128 1.634 10.658-.738 11.076-1.156c0 0-3.786 1.751-10.359-1.476c.952-1.212 3.854-2.909 3.854-2.909c-.553-.346-4.078-.225-6.485 1.429a37.028 37.028 0 0 1-3.673-2.675l.84-.871c3.25-3.384 6.944-2.584 6.944-2.584c-.638-.613-5.599-3.441-9.583.7l-.613.638a54.727 54.727 0 0 1-1.294-1.25l-1.85-1.85l1.064-1.065c3.321-3.32 8.226-3.451 8.226-3.451c-.626-.627-6.863-2.649-10.924 1.412l-.736.735l-8.292-8.294c-.626-.627-1.692-.575-2.317.05c-.626.626-.677 1.691-.051 2.317l8.293 8.293l-.059.059C4.684 21.924 6.37 28.496 6.997 29.123c0 0 .468-5.242 3.789-8.562l.387-.388l3.501 3.502c.057.057.113.106.17.163c-2.425 4.797 1.229 10.34 1.958 10.784c0 0-1.465-4.723.48-8.635c1.526 1.195 3.02 2.095 4.457 2.755c.083 2.993 2.707 5.7 3.344 5.931c0 0-.911-3.003-.534-4.487l.135-.376z"></path>
                            <path fill="#5DADEC" d="M22.083 10a1.001 1.001 0 0 1-.375-1.927c.166-.068 4.016-1.698 4.416-6.163a1 1 0 1 1 1.992.178c-.512 5.711-5.451 7.755-5.661 7.839a.978.978 0 0 1-.372.073zm5 4a1 1 0 0 1-.334-1.942c.188-.068 4.525-1.711 5.38-8.188a.99.99 0 0 1 1.122-.86a.998.998 0 0 1 .86 1.122c-1.021 7.75-6.468 9.733-6.699 9.813c-.109.037-.22.055-.329.055zm3.001 6a1.001 1.001 0 0 1-.483-1.876c.027-.015 2.751-1.536 3.601-3.518a1 1 0 0 1 1.837.788c-1.123 2.62-4.339 4.408-4.475 4.483a1.003 1.003 0 0 1-.48.123z"></path>
                        </svg>
                    </span>
                    <a href="/" class="branding-title">言葉</a>
                </div>
            </div>
            <div class="header-actions">
                <!-- 用户账户 -->
                <div class="user-account">
                    <!-- 未登录菜单触发器 -->
                    <div id="guestProfile" class="user-profile" style="display: flex;">
                        <button class="guest-menu-trigger" aria-label="メニュー">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                        </button>
                        <div id="guestMenu" class="user-menu">
                            <button id="loginButtonMenu" class="user-menu-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                                </svg>
                                <span>ログイン</span>
                            </button>
                            <div class="user-menu-divider"></div>
                            <button id="dictionaryButtonMenuGuest" class="user-menu-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                    <line x1="10" y1="8" x2="16" y2="8"></line>
                                    <line x1="10" y1="12" x2="16" y2="12"></line>
                                    <line x1="10" y1="16" x2="14" y2="16"></line>
                                </svg>
                                <span>辞書を切り替え</span>
                            </button>
                            <button id="settingsButtonMenuGuest" class="user-menu-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"></path>
                                </svg>
                                <span>設定</span>
                            </button>
                            <div class="user-menu-divider"></div>
                            <button id="installPWAGuest" class="user-menu-item" style="display: none;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                <span>アプリをインストール</span>
                            </button>
                        </div>
                    </div>
                    <!-- 已登录用户资料 -->
                    <div id="userProfile" class="user-profile" style="display: none;">
                        <img id="userAvatar" class="user-avatar" src="" alt="User">
                        <div id="userMenu" class="user-menu">
                            <div class="user-menu-header">
                                <img id="userAvatarMenu" class="user-avatar-large" src="" alt="User">
                                <div class="user-info">
                                    <div id="userNameMenu" class="user-name"></div>
                                    <div id="userEmailMenu" class="user-email"></div>
                                </div>
                            </div>
                            <div class="user-menu-divider"></div>
                            <button id="syncDataButton" class="user-menu-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 4 23 10 17 10"></polyline>
                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                                </svg>
                                <span>データを同期</span>
                            </button>
                            <button id="viewWrongWordsButton" class="user-menu-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                                <span>統計</span>
                            </button>
                            <button id="practiceWrongWordsButton" class="user-menu-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                                </svg>
                                <span>錯題を練習</span>
                            </button>
                            <div class="user-menu-divider"></div>
                            <button id="dictionaryButtonMenu" class="user-menu-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                    <line x1="10" y1="8" x2="16" y2="8"></line>
                                    <line x1="10" y1="12" x2="16" y2="12"></line>
                                    <line x1="10" y1="16" x2="14" y2="16"></line>
                                </svg>
                                <span>辞書を切り替え</span>
                            </button>
                            <button id="settingsButtonMenu" class="user-menu-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"></path>
                                </svg>
                                <span>設定</span>
                            </button>
                            <div class="user-menu-divider"></div>
                            <button id="installPWAUser" class="user-menu-item" style="display: none;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                <span>アプリをインストール</span>
                            </button>
                            <button id="switchAccountButton" class="user-menu-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                <span>アカウントを切り替え</span>
                            </button>
                            <button id="logoutButton" class="user-menu-item logout">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                    <polyline points="16 17 21 12 16 7"></polyline>
                                    <line x1="21" y1="12" x2="9" y2="12"></line>
                                </svg>
                                <span>ログアウト</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="main">
            <div id="loading-indicator" class="loading hidden" role="status" aria-live="polite">
                <div class="spinner" aria-hidden="true"></div>
                <p class="loading-text">読み込み中…</p>
            </div>

            <section id="question" class="card game-card">
                <div class="word-container">
                    <h1 id="question-word" class="word" aria-live="polite"></h1>
                    <button id="tts-button" type="button" class="tts-button" title="発音を聞く" aria-label="発音を聞く">
                        <svg class="tts-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                            <path d="M4 9v6h3.5L12 18V6L7.5 9H4z"></path>
                            <path d="M16 12a2 2 0 01-1.17 1.83l-.33.12v-3.9l.33.12A2 2 0 0116 12z"></path>
                            <path d="M18.5 12a4.5 4.5 0 01-3.05 4.24l-.45.15v-1.66l.18-.08A2.9 2.9 0 0017 12a2.9 2.9 0 00-1.82-2.65l-.18-.07V7.62l.45.15A4.5 4.5 0 0118.5 12z"></path>
                        </svg>
                        <span class="sr-only">発音を聞く</span>
                    </button>
                </div>
                <p id="question-meaning" class="meaning"></p>
                <p id="question-reading" class="reading"></p>
                <p id="question-romaji" class="romaji"></p>
                <form id="answer-form" class="answer-form" autocomplete="off">
                    <label class="sr-only" for="answer-input">答えを入力してください</label>
                    <input id="answer-input" type="text" inputmode="text" autocomplete="off" placeholder="" required>
                    <div class="actions">
                        <button type="submit" id="answer-submit">回答</button>
                        <button type="button" id="skip-button" class="skip-button" title="この問題をスキップ">スキップ</button>
                    </div>
                </form>
            </section>
            <section id="alerts" class="alerts" aria-live="polite"></section>
            
            <!-- 游戏化进度面板 -->
            <section class="game-progress-panel" aria-label="学習進捗">
                <div class="player-stats">
                    <div class="player-avatar">
                        <div class="avatar-ring">
                            <div class="avatar-icon" id="game-avatar-container">
                                <img id="gameUserAvatar" class="game-user-avatar hidden" src="" alt="User">
                                <span id="gameDefaultAvatar" class="game-default-avatar">⚔️</span>
                            </div>
                        </div>
                        <div class="level-badge" id="level-badge">Lv.1</div>
                    </div>
                    
                    <div class="player-info">
                        <div class="exp-container">
                            <div class="exp-header">
                                <span class="exp-label">経験値</span>
                                <button id="progress-reset" class="progress-reset-btn" type="button" title="進捗をリセット">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                                        <path d="M3 3v5h5"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="exp-bar-wrapper">
                                <div id="exp-bar" class="exp-bar" role="progressbar">
                                    <div id="exp-fill" class="exp-bar-fill"></div>
                                    <div class="exp-bar-shine"></div>
                                </div>
                                <div class="exp-text" id="exp-text">0 / 100</div>
                            </div>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-item stat-correct">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                </svg>
                                <span class="stat-value" id="correct-stat">0</span>
                            </div>
                            <div class="stat-item stat-wrong">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="15" y1="9" x2="9" y2="15"></line>
                                    <line x1="9" y1="9" x2="15" y2="15"></line>
                                </svg>
                                <span class="stat-value" id="wrong-stat">0</span>
                            </div>
                            <div class="stat-item stat-combo">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                                </svg>
                                <span class="stat-value" id="combo-stat">0</span>
                            </div>
                            <div class="stat-item stat-total">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                </svg>
                                <span class="stat-value" id="total-stat">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="progress-text-info" id="progress-text-info">
                    <span id="progress-fraction">0 / 0</span>
                    <span class="progress-percentage" id="progress-percentage">0%</span>
                    <span id="dictionary-name" class="dictionary-name"></span>
                </div>
            </section>
        </main>

        <footer class="footer">
            © <a href="https://iamcheyan.com/" target="_blank" rel="noreferrer noopener">Cheyan</a> All Rights Reserved ·
            <a href="https://github.com/iamcheyan/kotoba" target="_blank" rel="noreferrer noopener">GitHub</a>
        </footer>
    </div>

    <div id="modal-backdrop" class="modal-backdrop hidden" data-close="modal"></div>

    <div id="dictionary-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="dictionary-modal-title">
        <div class="modal-header">
            <h2 id="dictionary-modal-title">辞書選択</h2>
            <button type="button" class="modal-close" data-close="modal" aria-label="閉じる">×</button>
        </div>
        <div class="modal-body dictionary-modal-body">
            <div class="dictionary-select-group">
                <label for="dictionary-select">利用する辞書を選択</label>
                <select id="dictionary-select"></select>
            </div>
            <div class="voice-selection">
                <label for="voice-select">音声選択:</label>
                <select id="voice-select">
                    <option value="">読み込み中...</option>
                </select>
                <button type="button" id="voice-preview" class="ghost-button" title="選択中の音声で試聴します" aria-label="音声を試聴">▶︎ 試聴</button>
            </div>
            <div class="rate-control">
                <label for="rate-slider">読み上げ速度:</label>
                <div class="rate-control__track">
                    <input id="rate-slider" type="range" min="0.5" max="2" step="0.1" value="1" />
                    <span id="rate-value">1.0x</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="ghost-button" data-close="modal">キャンセル</button>
            <button type="button" id="dictionary-save">確認</button>
        </div>
    </div>

    <div id="settings-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="settings-modal-title">
        <div class="modal-header">
            <h2 id="settings-modal-title">設定</h2>
            <button type="button" class="modal-close" data-close="modal" aria-label="閉じる">×</button>
        </div>
        <div class="modal-body">
            <div class="settings-checkbox-grid">
                <label class="checkbox">
                    <input type="checkbox" id="toggle-reading" checked>
                    読み方を表示する
                </label>
                <label class="checkbox">
                    <input type="checkbox" id="toggle-romaji" checked>
                    ローマ字を表示する
                </label>
                <label class="checkbox">
                    <input type="checkbox" id="toggle-placeholder" checked>
                    入力ヒントを表示する
                </label>
                <label class="checkbox">
                    <input type="checkbox" id="toggle-katakana">
                    カタカナにも振り仮名を表示する
                </label>
                <label class="checkbox">
                    <input type="checkbox" id="toggle-furigana" checked>
                    振り仮名を表示する
                </label>
                <label class="checkbox">
                    <input type="checkbox" id="toggle-auto-pronunciation">
                    自動発音
                </label>
            </div>
            <fieldset class="theme-options">
                <legend>テーマ</legend>
                <label class="theme-option" for="theme-classic">
                    <input type="radio" name="theme" id="theme-classic" value="classic" checked>
                    <span class="theme-option__indicator" aria-hidden="true"></span>
                    <span class="theme-option__preview theme-option__preview--classic" aria-hidden="true"></span>
                    <span class="theme-option__content">
                        <span class="theme-option__name">クラシック</span>
                        <span class="theme-option__description">落ち着いたブルーとホワイト</span>
                    </span>
                </label>
                <label class="theme-option" for="theme-sakura">
                    <input type="radio" name="theme" id="theme-sakura" value="sakura">
                    <span class="theme-option__indicator" aria-hidden="true"></span>
                    <span class="theme-option__preview theme-option__preview--sakura" aria-hidden="true"></span>
                    <span class="theme-option__content">
                        <span class="theme-option__name">桜ブロッサム</span>
                        <span class="theme-option__description">春らしい桜色の柔らかなテーマ</span>
                    </span>
                </label>
            </fieldset>
        </div>
        <div class="modal-footer">
            <button type="button" class="ghost-button" data-close="modal">キャンセル</button>
            <button type="button" id="settings-save">確認</button>
        </div>
    </div>

    <!-- 错题本查看面板 -->
    <div id="wrong-words-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="wrong-words-modal-title">
        <div class="modal-header">
            <h2 id="wrong-words-modal-title">統計</h2>
            <button type="button" class="modal-close" data-close="modal" aria-label="閉じる">×</button>
        </div>
        <div class="modal-body wrong-words-body">
            <div class="wrong-words-stats">
                <div class="stat-card stat-correct">
                    <div class="stat-number" id="correct-count">0</div>
                    <div class="stat-label">正解数</div>
                </div>
                <div class="stat-card stat-wrong">
                    <div class="stat-number" id="wrong-count">0</div>
                    <div class="stat-label">錯題数</div>
                </div>
            </div>
            <div class="wrong-words-actions">
                <button type="button" id="practice-wrong-words" class="ghost-button primary-button">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                    錯題を練習
                </button>
                <button type="button" id="clear-all-wrong-words" class="ghost-button danger-button" title="すべてクリア">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </div>
            <div id="wrong-words-list" class="wrong-words-list">
                <!-- 错题列表将在这里显示 -->
            </div>
            <div id="wrong-words-pagination" class="pagination hidden">
                <button id="prev-page" class="pagination-btn" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    前へ
                </button>
                <div class="pagination-info">
                    <span id="current-page">1</span> / <span id="total-pages">1</span>
                </div>
                <button id="next-page" class="pagination-btn" disabled>
                    次へ
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- PWA Install Progress Modal -->
    <div id="pwa-install-modal" class="modal hidden" role="dialog" aria-modal="true">
        <div class="modal-header">
            <h2>アプリをインストール</h2>
            <button type="button" class="modal-close" data-close="pwa-modal" aria-label="閉じる">×</button>
        </div>
        <div class="modal-body">
            <div id="pwa-install-content">
                <div class="pwa-step" id="pwa-step-1">
                    <div class="pwa-icon">📱</div>
                    <h3>キャッシュをクリア中...</h3>
                    <div class="pwa-progress">
                        <div class="pwa-progress-bar" id="pwa-progress-1" style="width: 0%"></div>
                    </div>
                    <p class="pwa-progress-text" id="pwa-progress-text-1">準備中...</p>
                </div>
                <div class="pwa-step hidden" id="pwa-step-2">
                    <div class="pwa-icon">⬇️</div>
                    <h3>リソースをダウンロード中...</h3>
                    <div class="pwa-progress">
                        <div class="pwa-progress-bar" id="pwa-progress-2" style="width: 0%"></div>
                    </div>
                    <p class="pwa-progress-text" id="pwa-progress-text-2">0 / 0 ファイル</p>
                </div>
                <div class="pwa-step hidden" id="pwa-step-3">
                    <div class="pwa-icon">✅</div>
                    <h3>インストール完了！</h3>
                    <p>アプリをホーム画面に追加できます</p>
                    <button type="button" id="pwa-add-to-home" class="primary-button" style="max-width: 100%; margin-top: 16px;">
                        ホーム画面に追加
                    </button>
                </div>
                <div class="pwa-step hidden" id="pwa-step-error">
                    <div class="pwa-icon">❌</div>
                    <h3>インストールに失敗しました</h3>
                    <p id="pwa-error-message"></p>
                    <button type="button" class="ghost-button" data-close="pwa-modal" style="margin-top: 16px;">
                        閉じる
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAOp_lGAlIBxP5pFQID_RPelmLE4NTvZ2s",
            authDomain: "kotoba-60aeb.firebaseapp.com",
            projectId: "kotoba-60aeb",
            storageBucket: "kotoba-60aeb.firebasestorage.app",
            messagingSenderId: "367445040315",
            appId: "1:367445040315:web:1b68e59976ac2ab1f91d9e",
            measurementId: "G-CT0R8S7TQG"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        // 强制显示账户选择界面
        provider.setCustomParameters({
            prompt: 'select_account'
        });

        // Make auth and db available globally
        window.firebaseAuth = auth;
        window.firebaseDb = db;

        // UI Elements
        const loginButton = document.getElementById('loginButton');
        const loginButtonMenu = document.getElementById('loginButtonMenu');
        const userProfile = document.getElementById('userProfile');
        const guestProfile = document.getElementById('guestProfile');
        const guestMenuTrigger = document.querySelector('.guest-menu-trigger');
        const guestMenu = document.getElementById('guestMenu');
        const userAvatar = document.getElementById('userAvatar');
        const userAvatarMenu = document.getElementById('userAvatarMenu');
        const userNameMenu = document.getElementById('userNameMenu');
        const userEmailMenu = document.getElementById('userEmailMenu');
        const userMenu = document.getElementById('userMenu');
        const logoutButton = document.getElementById('logoutButton');
        const syncDataButton = document.getElementById('syncDataButton');
        const switchAccountButton = document.getElementById('switchAccountButton');
        const dictionaryButtonMenuGuest = document.getElementById('dictionaryButtonMenuGuest');
        const settingsButtonMenuGuest = document.getElementById('settingsButtonMenuGuest');

        // Toggle guest menu
        if (guestMenuTrigger) {
            guestMenuTrigger.addEventListener('click', (e) => {
                e.stopPropagation();
                if (guestMenu) guestMenu.classList.toggle('show');
            });
        }

        // Toggle user menu
        if (userAvatar) {
            userAvatar.addEventListener('click', (e) => {
                e.stopPropagation();
                if (userMenu) userMenu.classList.toggle('show');
            });
        }

        // Close menu when clicking outside
        document.addEventListener('click', () => {
            if (userMenu) userMenu.classList.remove('show');
            if (guestMenu) guestMenu.classList.remove('show');
        });

        // Prevent menu from closing when clicking inside
        if (userMenu) {
            userMenu.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }
        
        if (guestMenu) {
            guestMenu.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }
        
        // Guest menu actions
        if (loginButtonMenu) {
            loginButtonMenu.addEventListener('click', async () => {
                try {
                    sessionStorage.removeItem('dataLoaded');
                    const result = await signInWithPopup(auth, provider);
                    const user = result.user;
                    console.log('User signed in:', user.displayName);
                    showNotification('ログインしました', 'success');
                    if (guestMenu) guestMenu.classList.remove('show');
                } catch (error) {
                    console.error('Login error:', error);
                    showNotification('ログインエラー: ' + error.message, 'error');
                }
            });
        }
        
        if (dictionaryButtonMenuGuest) {
            dictionaryButtonMenuGuest.addEventListener('click', function() {
                const dictionaryModal = document.getElementById('dictionary-modal');
                const backdrop = document.getElementById('modal-backdrop');
                if (dictionaryModal) {
                    dictionaryModal.classList.remove('hidden');
                }
                if (backdrop) {
                    backdrop.classList.remove('hidden');
                }
                if (guestMenu) guestMenu.classList.remove('show');
            });
        }
        
        if (settingsButtonMenuGuest) {
            settingsButtonMenuGuest.addEventListener('click', function() {
                const settingsModal = document.getElementById('settings-modal');
                const backdrop = document.getElementById('modal-backdrop');
                if (settingsModal) {
                    settingsModal.classList.remove('hidden');
                }
                if (backdrop) {
                    backdrop.classList.remove('hidden');
                }
                if (guestMenu) guestMenu.classList.remove('show');
            });
        }

        // Login with Google
        if (loginButton) {
            loginButton.addEventListener('click', async () => {
                try {
                    sessionStorage.removeItem('dataLoaded');
                    const result = await signInWithPopup(auth, provider);
                    const user = result.user;
                    console.log('User signed in:', user.displayName);
                    showNotification('ログインしました', 'success');
                } catch (error) {
                    console.error('Login error:', error);
                    showNotification('ログインエラー: ' + error.message, 'error');
                }
            });
        }

        // Logout
        if (logoutButton) {
            logoutButton.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    console.log('User signed out');
                    showNotification('ログアウトしました', 'success');
                } catch (error) {
                    console.error('Logout error:', error);
                    showNotification('ログアウトエラー: ' + error.message, 'error');
                }
            });
        }

        // Switch account
        if (switchAccountButton) {
            switchAccountButton.addEventListener('click', async () => {
                try {
                    sessionStorage.removeItem('dataLoaded');
                    await signOut(auth);
                    setTimeout(async () => {
                        try {
                            const result = await signInWithPopup(auth, provider);
                            console.log('Switched to account:', result.user.displayName);
                            showNotification('アカウントを切り替えました', 'success');
                        } catch (error) {
                            console.error('Switch account error:', error);
                            showNotification('切り替えエラー: ' + error.message, 'error');
                        }
                    }, 100);
                } catch (error) {
                    console.error('Logout error during switch:', error);
                }
            });
        }

        // Sync data to Firestore
        async function syncUserData(user) {
            if (!user) return;

            try {
                const userRef = doc(db, 'users', user.uid);
                
                const localData = {
                    // 学习进度
                    correct: parseInt(localStorage.getItem('correct') || '0', 10),
                    wrong: parseInt(localStorage.getItem('wrong') || '0', 10),
                    
                    // 错题本
                    wrongWords: JSON.parse(localStorage.getItem('wrongWords') || '[]'),
                    
                    // 用户偏好
                    lastSelectedDictionary: localStorage.getItem('lastSelectedDictionary'),
                    selectedVoice: localStorage.getItem('selectedVoice'),
                    speechRate: localStorage.getItem('speechRate'),
                    theme: localStorage.getItem('kotoba.theme'),
                    
                    // 同步时间
                    lastSync: new Date().toISOString(),
                    
                    // 用户信息
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL
                };

                await setDoc(userRef, localData, { merge: true });
                console.log('✅ 数据已同步到云端');
            } catch (error) {
                console.error('❌ 同步数据失败:', error);
                throw error;
            }
        }

        // Load user data from Firestore
        async function loadUserData(user, options = {}) {
            if (!user) return;
            
            const { silent = false } = options;

            try {
                const userRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userRef);

                if (userDoc.exists()) {
                    const cloudData = userDoc.data();
                    console.log('📥 正在从云端加载数据...');
                    
                    // 同步学习进度
                    if (cloudData.correct !== undefined) {
                        localStorage.setItem('correct', String(cloudData.correct));
                    }
                    if (cloudData.wrong !== undefined) {
                        localStorage.setItem('wrong', String(cloudData.wrong));
                    }
                    
                    // 同步错题本 - 合并去重
                    if (cloudData.wrongWords && Array.isArray(cloudData.wrongWords)) {
                        const localWrongWords = JSON.parse(localStorage.getItem('wrongWords') || '[]');
                        const mergedWrongWords = [...new Set([...cloudData.wrongWords, ...localWrongWords])];
                        localStorage.setItem('wrongWords', JSON.stringify(mergedWrongWords));
                        console.log('✅ 错题本已同步:', mergedWrongWords.length, '个单词');
                    }
                    
                    // 同步用户偏好
                    if (cloudData.lastSelectedDictionary) {
                        localStorage.setItem('lastSelectedDictionary', cloudData.lastSelectedDictionary);
                    }
                    if (cloudData.selectedVoice) {
                        localStorage.setItem('selectedVoice', cloudData.selectedVoice);
                    }
                    if (cloudData.speechRate) {
                        localStorage.setItem('speechRate', cloudData.speechRate);
                    }
                    if (cloudData.theme) {
                        localStorage.setItem('kotoba.theme', cloudData.theme);
                    }

                    console.log('🎉 数据加载完成！');
                    sessionStorage.setItem('dataLoaded', 'true');
                    
                    if (!silent) {
                        showNotification('データを読み込みました', 'success');
                    }
                    
                    // 刷新界面
                    if (window.updateScoreboard) {
                        window.updateScoreboard();
                    }
                } else {
                    // 首次登录，上传本地数据
                    console.log('📤 首次登录，正在上传本地数据...');
                    await syncUserData(user);
                    sessionStorage.setItem('dataLoaded', 'true');
                }
            } catch (error) {
                console.error('❌ 加载数据失败:', error);
            }
        }

        // Sync data button
        if (syncDataButton) {
            syncDataButton.addEventListener('click', async () => {
                const user = auth.currentUser;
                if (user) {
                    try {
                        console.log('🔄 开始同步...');
                        await loadUserData(user, { silent: true });
                        await syncUserData(user);
                        showNotification('データを同期しました', 'success');
                        
                        // 刷新界面
                        if (window.updateScoreboard) {
                            window.updateScoreboard();
                        }
                        console.log('✅ 同步完成');
                    } catch (error) {
                        console.error('Sync error:', error);
                        showNotification('同期エラー: ' + error.message, 'error');
                    }
                }
            });
        }

        // Auth state observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log('User is signed in:', user.displayName);
                
                // Update UI - 显示已登录状态
                if (guestProfile) guestProfile.style.display = 'none';
                if (userProfile) userProfile.style.display = 'flex';
                if (userAvatar) userAvatar.src = user.photoURL || '';
                if (userAvatarMenu) userAvatarMenu.src = user.photoURL || '';
                if (userNameMenu) userNameMenu.textContent = user.displayName || 'User';
                if (userEmailMenu) userEmailMenu.textContent = user.email || '';
                if (guestMenu) guestMenu.classList.remove('show');
                
                // 更新游戏面板头像
                const gameUserAvatar = document.getElementById('gameUserAvatar');
                const gameDefaultAvatar = document.getElementById('gameDefaultAvatar');
                if (gameUserAvatar && user.photoURL) {
                    gameUserAvatar.src = user.photoURL;
                    gameUserAvatar.classList.remove('hidden');
                    if (gameDefaultAvatar) gameDefaultAvatar.classList.add('hidden');
                }

                // Load user data
                const dataLoaded = sessionStorage.getItem('dataLoaded');
                if (dataLoaded !== 'true') {
                    await loadUserData(user);
                }
                
                // 刷新字典列表以显示错题本
                if (window.populateDictionarySelect) {
                    window.populateDictionarySelect();
                }
            } else {
                console.log('User is signed out');
                sessionStorage.removeItem('dataLoaded');
                
                // Update UI - 显示未登录状态
                if (guestProfile) guestProfile.style.display = 'flex';
                if (userProfile) userProfile.style.display = 'none';
                if (userMenu) userMenu.classList.remove('show');
                if (guestMenu) guestMenu.classList.remove('show');
                
                // 恢复游戏面板默认头像
                const gameUserAvatar = document.getElementById('gameUserAvatar');
                const gameDefaultAvatar = document.getElementById('gameDefaultAvatar');
                if (gameUserAvatar) {
                    gameUserAvatar.classList.add('hidden');
                    gameUserAvatar.src = '';
                }
                if (gameDefaultAvatar) gameDefaultAvatar.classList.remove('hidden');
                
                // 刷新字典列表以隐藏错题本
                if (window.populateDictionarySelect) {
                    window.populateDictionarySelect();
                }
            }
        });

        // Make functions available globally
        window.syncUserData = syncUserData;
        window.loadUserData = loadUserData;
        
        // Auto-sync on data changes
        let autoSyncTimer = null;
        window.autoSyncData = function() {
            if (!window.firebaseAuth || !window.syncUserData) return;
            
            const user = window.firebaseAuth.currentUser;
            if (!user) return;
            
            if (autoSyncTimer) clearTimeout(autoSyncTimer);
            
            autoSyncTimer = setTimeout(async () => {
                try {
                    console.log('🔄 自动同步...');
                    await window.syncUserData(user);
                } catch (error) {
                    console.error('❌ 自动同步失败:', error);
                }
            }, 1000);
        };
        
        // Sync before page unload
        window.addEventListener('beforeunload', async () => {
            const user = auth.currentUser;
            if (user) {
                try {
                    await syncUserData(user);
                } catch (error) {
                    console.error('Error syncing on page unload:', error);
                }
            }
        });
        
        // Simple notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                background: ${type === 'success' ? '#16a34a' : type === 'error' ? '#dc2626' : '#4f46e5'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-size: 14px;
                max-width: 320px;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
    </script>

    <!-- PWA Installation Script -->
    <script>
        let deferredPrompt;
        const installPWAGuest = document.getElementById('installPWAGuest');
        const installPWAUser = document.getElementById('installPWAUser');
        const pwaModal = document.getElementById('pwa-install-modal');
        const pwaBackdrop = document.getElementById('modal-backdrop');
        const pwaAddToHomeBtn = document.getElementById('pwa-add-to-home');

        // Listen for beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install buttons
            if (installPWAGuest) installPWAGuest.style.display = 'flex';
            if (installPWAUser) installPWAUser.style.display = 'flex';
            
            console.log('[PWA] Install prompt captured');
        });

        // Handle PWA installation
        async function installPWA() {
            if (!deferredPrompt) {
                // iOS or already installed
                showIOSInstallInstructions();
                return;
            }

            try {
                // Show modal
                if (pwaModal) pwaModal.classList.remove('hidden');
                if (pwaBackdrop) pwaBackdrop.classList.remove('hidden');
                
                // Close menus
                document.getElementById('guestMenu')?.classList.remove('show');
                document.getElementById('userMenu')?.classList.remove('show');

                // Step 1: Clear cache
                await showStep('pwa-step-1');
                await clearAllCaches();
                
                // Step 2: Download resources
                await showStep('pwa-step-2');
                await downloadResources();
                
                // Step 3: Show install prompt
                await showStep('pwa-step-3');
                
            } catch (error) {
                console.error('[PWA] Installation error:', error);
                showError(error.message);
            }
        }

        async function clearAllCaches() {
            const progressBar = document.getElementById('pwa-progress-1');
            const progressText = document.getElementById('pwa-progress-text-1');
            
            try {
                progressText.textContent = 'キャッシュを削除中...';
                progressBar.style.width = '30%';
                
                // Clear all caches
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
                
                progressBar.style.width = '100%';
                progressText.textContent = '完了';
                
                await new Promise(resolve => setTimeout(resolve, 500));
            } catch (error) {
                console.error('[PWA] Cache clear error:', error);
            }
        }

        async function downloadResources() {
            const progressBar = document.getElementById('pwa-progress-2');
            const progressText = document.getElementById('pwa-progress-text-2');
            
            const resources = [
                '/',
                '/index.html',
                '/static/app.js',
                '/static/styles.css',
                '/static/config.json',
                '/manifest.json'
            ];
            
            let completed = 0;
            progressText.textContent = `${completed} / ${resources.length} ファイル`;
            
            for (const url of resources) {
                try {
                    await fetch(url, { cache: 'reload' });
                    completed++;
                    const percent = (completed / resources.length) * 100;
                    progressBar.style.width = `${percent}%`;
                    progressText.textContent = `${completed} / ${resources.length} ファイル`;
                    await new Promise(resolve => setTimeout(resolve, 100));
                } catch (error) {
                    console.error(`[PWA] Failed to download ${url}:`, error);
                }
            }
        }

        function showStep(stepId) {
            return new Promise(resolve => {
                document.querySelectorAll('.pwa-step').forEach(step => {
                    step.classList.add('hidden');
                });
                const step = document.getElementById(stepId);
                if (step) {
                    step.classList.remove('hidden');
                }
                setTimeout(resolve, 300);
            });
        }

        function showError(message) {
            showStep('pwa-step-error');
            const errorMsg = document.getElementById('pwa-error-message');
            if (errorMsg) errorMsg.textContent = message;
        }

        function showIOSInstallInstructions() {
            // Show iOS install instructions
            if (pwaModal) pwaModal.classList.remove('hidden');
            if (pwaBackdrop) pwaBackdrop.classList.remove('hidden');
            
            document.querySelectorAll('.pwa-step').forEach(step => step.classList.add('hidden'));
            
            const iosStep = document.createElement('div');
            iosStep.className = 'pwa-step';
            iosStep.innerHTML = `
                <div class="pwa-icon">📱</div>
                <h3>ホーム画面に追加</h3>
                <p style="text-align: left; margin: 16px 0;">
                    <strong>iOS の場合:</strong><br>
                    1. 共有ボタン <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle;"><path d="M16 5l-1.42 1.42-1.59-1.59V16h-1.98V4.83L9.42 6.42 8 5l4-4 4 4zm4 5v11c0 1.1-.9 2-2 2H6c-1.11 0-2-.9-2-2V10c0-1.11.89-2 2-2h3v2H6v11h12V10h-3V8h3c1.1 0 2 .89 2 2z"/></svg> をタップ<br>
                    2. 「ホーム画面に追加」を選択<br>
                    3. 「追加」をタップ
                </p>
                <button type="button" class="ghost-button" data-close="pwa-modal" style="margin-top: 16px;">閉じる</button>
            `;
            
            const content = document.getElementById('pwa-install-content');
            if (content) {
                content.appendChild(iosStep);
            }
        }

        // Add to home screen button
        if (pwaAddToHomeBtn) {
            pwaAddToHomeBtn.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                console.log(`[PWA] User response: ${outcome}`);
                
                if (outcome === 'accepted') {
                    console.log('[PWA] PWA installed');
                }
                
                deferredPrompt = null;
                if (installPWAGuest) installPWAGuest.style.display = 'none';
                if (installPWAUser) installPWAUser.style.display = 'none';
                
                // Close modal
                if (pwaModal) pwaModal.classList.add('hidden');
                if (pwaBackdrop) pwaBackdrop.classList.add('hidden');
            });
        }

        // Install button click handlers
        if (installPWAGuest) {
            installPWAGuest.addEventListener('click', installPWA);
        }
        if (installPWAUser) {
            installPWAUser.addEventListener('click', installPWA);
        }

        // Close PWA modal
        document.querySelectorAll('[data-close="pwa-modal"]').forEach(btn => {
            btn.addEventListener('click', () => {
                if (pwaModal) pwaModal.classList.add('hidden');
                if (pwaBackdrop) pwaBackdrop.classList.add('hidden');
            });
        });

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('[PWA] Service Worker registered:', registration.scope);
                    })
                    .catch(error => {
                        console.error('[PWA] Service Worker registration failed:', error);
                    });
            });
        }

        // Listen for app installed event
        window.addEventListener('appinstalled', () => {
            console.log('[PWA] App installed');
            deferredPrompt = null;
            if (installPWAGuest) installPWAGuest.style.display = 'none';
            if (installPWAUser) installPWAUser.style.display = 'none';
        });
    </script>
</body>
</html>
