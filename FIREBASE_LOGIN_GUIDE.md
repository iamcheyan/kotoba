# Kotoba - Google 登录功能使用指南

## 功能概述

已成功为 Kotoba 项目集成了 Google 登录功能，实现了用户认证和云端数据同步。

## 主要功能

### 1. **用户认证**
- ✅ Google 账户登录
- ✅ 账户切换
- ✅ 登出功能
- ✅ 用户信息显示（头像、姓名、邮箱）

### 2. **数据同步**
自动同步以下数据到 Firebase Firestore：
- ✅ 学习进度（正解数、不正解数）
- ✅ 最后选择的词典
- ✅ 语音设置（选择的语音、语速）
- ✅ 主题设置

### 3. **同步触发时机**
- 用户登录后自动加载云端数据
- 回答问题时自动同步进度
- 更改设置时自动同步
- 切换词典时自动同步
- 调整语音设置时自动同步
- 页面关闭前自动同步

## 使用方法

### 登录
1. 点击页面右上角的「ログイン」按钮
2. 在弹出的 Google 登录窗口中选择账户
3. 授权后即可登录成功

### 查看用户信息
- 登录后，点击右上角的用户头像
- 会显示用户菜单，包含：
  - 用户信息
  - データを同期（手动同步）
  - アカウントを切り替え（切换账户）
  - ログアウト（登出）

### 手动同步
点击用户菜单中的「データを同期」按钮，可以立即执行双向同步。

### 切换账户
点击「アカウントを切り替え」，可以切换到另一个 Google 账户。

## 技术实现

### Firebase 配置
使用的 Firebase 项目配置：
- Project ID: `terebi-711fb`
- App ID: `1:54498356451:web:54522880222619f65669d6`

### 文件修改
1. **index.html**
   - 添加了用户登录 UI 组件
   - 集成了 Firebase SDK (v12.4.0)
   - 添加了认证和数据同步逻辑

2. **styles.css**
   - 添加了用户账户相关样式
   - 登录按钮样式
   - 用户菜单样式
   - 响应式设计支持

3. **app.js**
   - 暴露 `updateScoreboard` 函数供 Firebase 使用
   - 在关键操作点调用 `autoSyncData()` 实现自动同步

## 数据存储结构

Firestore 中用户数据结构：
```javascript
{
  users: {
    [user.uid]: {
      // 学习进度
      correct: number,
      wrong: number,
      
      // 用户偏好
      lastSelectedDictionary: string,
      selectedVoice: string,
      speechRate: string,
      theme: string,
      
      // 同步信息
      lastSync: timestamp,
      
      // 用户信息
      email: string,
      displayName: string,
      photoURL: string
    }
  }
}
```

## 注意事项

1. **首次登录**：首次登录时会上传本地数据到云端
2. **数据合并**：再次登录时会智能合并本地和云端数据
3. **自动同步**：所有设置更改会在 1 秒后自动同步到云端
4. **离线使用**：未登录时仍可正常使用，数据保存在本地
5. **隐私保护**：所有数据存储在用户自己的 Firebase 账户下

## 测试步骤

### 基本测试
1. ✅ 打开 Kotoba 应用
2. ✅ 点击登录按钮，使用 Google 账户登录
3. ✅ 确认用户头像显示正确
4. ✅ 回答几个问题，检查分数更新
5. ✅ 点击用户头像，查看用户菜单
6. ✅ 点击「データを同期」，确认同步成功

### 同步测试
1. ✅ 在设备 A 上登录并答题
2. ✅ 在设备 B 上使用相同账户登录
3. ✅ 确认设备 B 上显示设备 A 的学习进度
4. ✅ 在设备 B 上继续答题
5. ✅ 返回设备 A，手动同步，确认进度更新

### 设置同步测试
1. ✅ 更改主题设置
2. ✅ 切换词典
3. ✅ 调整语音设置
4. ✅ 在另一设备登录，确认设置已同步

## 开发者备注

- Firebase SDK 版本：12.4.0
- 使用 ES6 模块导入方式
- 支持多账户切换
- 实现了防抖机制避免频繁同步
- 页面卸载前自动保存数据

---

**开发完成时间**: 2025-10-13  
**参考项目**: Terebi

